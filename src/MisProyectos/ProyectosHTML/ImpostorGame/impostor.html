<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Juego del Impostor Online</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg: #e5e7eb;
            --card-bg: #ffffff;
            --panel-bg: #ffffff;
            --accent: #22c55e;
            --accent-soft: rgba(34,197,94,0.12);
            --danger: #ef4444;
            --danger-soft: rgba(239,68,68,0.12);
            --info-soft: rgba(59,130,246,0.12);
            --text-main: #111827;
            --text-muted: #6b7280;
            --border: #e5e7eb;
        }
        [data-theme="dark"] {
            --bg: #0f172a;
            --card-bg: #1e293b;
            --panel-bg: #1e293b;
            --accent: #22c55e;
            --accent-soft: rgba(34,197,94,0.2);
            --danger: #ef4444;
            --danger-soft: rgba(239,68,68,0.2);
            --info-soft: rgba(59,130,246,0.2);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
        }
        *{box-sizing:border-box;margin:0;padding:0}
        body{
            min-height:100vh;
            font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
            background:
                linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color:var(--text-main);
            display:flex;
            align-items:center;
            justify-content:center;
            padding:20px;
            transition:background 0.3s ease, color 0.3s ease;
            position:relative;
            overflow-x:hidden;
        }
        body::before{
            content:'';
            position:fixed;
            top:0;
            left:0;
            right:0;
            bottom:0;
            background:radial-gradient(circle at 20% 50%, rgba(120,119,198,0.3), transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(255,119,198,0.3), transparent 50%),
                        radial-gradient(circle at 40% 20%, rgba(120,219,255,0.3), transparent 50%);
            pointer-events:none;
            z-index:0;
        }
        @keyframes gradientShift{
            0%{background-position:0% 50%;}
            50%{background-position:100% 50%;}
            100%{background-position:0% 50%;}
        }
        [data-theme="dark"] body{
            background:linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #1a1a2e 100%);
            background-size: 400% 400%;
        }
        [data-theme="dark"] body::before{
            background:radial-gradient(circle at 20% 50%, rgba(34,197,94,0.1), transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(59,130,246,0.1), transparent 50%),
                        radial-gradient(circle at 40% 20%, rgba(139,92,246,0.1), transparent 50%);
        }
        .app{
            width:100%;
            max-width:1200px;
            background:rgba(255,255,255,0.98);
            backdrop-filter:blur(20px);
            border-radius:32px;
            border:2px solid rgba(255,255,255,0.3);
            box-shadow:0 25px 50px rgba(0,0,0,0.25),
                       0 0 0 1px rgba(255,255,255,0.1) inset,
                       0 0 100px rgba(120,119,198,0.2);
            padding:32px;
            position:relative;
            overflow:hidden;
            transition:all 0.3s ease;
            z-index:1;
        }
        .app::before{
            content:'';
            position:absolute;
            top:-50%;
            left:-50%;
            width:200%;
            height:200%;
            background:radial-gradient(circle, rgba(120,119,198,0.1) 0%, transparent 70%);
            animation:rotate 20s linear infinite;
            pointer-events:none;
        }
        @keyframes rotate{
            from{transform:rotate(0deg);}
            to{transform:rotate(360deg);}
        }
        [data-theme="dark"] .app{
            background:rgba(15,23,42,0.95);
            backdrop-filter:blur(20px);
            border-color:rgba(59,130,246,0.3);
            box-shadow:0 25px 50px rgba(0,0,0,0.5),
                       0 0 0 1px rgba(59,130,246,0.1) inset,
                       0 0 100px rgba(34,197,94,0.15);
        }
        .app-inner{position:relative;z-index:1}
        header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:10px;
            margin-bottom:16px;
        }
        .title{
            display:flex;
            align-items:center;
            gap:10px;
        }
        .title-icon{
            width:44px;height:44px;border-radius:999px;
            background:radial-gradient(circle at 30% 30%,#22c55e,#16a34a);
            box-shadow:0 0 18px rgba(34,197,94,0.5);
            display:flex;align-items:center;justify-content:center;
            font-size:24px;color:#022c22;
        }
        .title-text h1{
            margin:0;
            font-size:22px;
            letter-spacing:.06em;
            text-transform:uppercase;
        }
        .title-text span{
            font-size:12px;
            color:var(--text-muted);
        }
        .header-right{
            display:flex;
            flex-direction:column;
            align-items:flex-end;
            gap:6px;
        }
        .badge{
            border-radius:999px;
            border:1px solid rgba(148,163,184,0.6);
            padding:3px 10px;
            font-size:11px;
            text-transform:uppercase;
            letter-spacing:.08em;
            color:var(--text-muted);
        }
        main{
            display:grid;
            grid-template-columns:minmax(0,1.35fr) minmax(0,1.1fr);
            gap:16px;
        }
        @media(max-width:900px){
            main{grid-template-columns:minmax(0,1fr)}
        }
        
        /* Estilos para mÃ³viles */
        @media(max-width:768px){
            body{
                padding:10px;
            }
            .app{
                max-width:100%;
                padding:16px;
                border-radius:20px;
            }
            header{
                flex-direction:column;
                gap:12px;
                align-items:flex-start;
            }
            .title-text h1{
                font-size:18px;
            }
            .card{
                padding:16px;
                border-radius:16px;
            }
            .card h2{
                font-size:16px;
            }
            input[type=text], input[type=number], select{
                padding:12px;
                font-size:16px; /* Evita zoom en iOS */
            }
            .btn{
                padding:12px 20px;
                font-size:14px;
                min-height:44px; /* TamaÃ±o tÃ¡ctil mÃ­nimo */
            }
            .btn-row{
                flex-direction:column;
            }
            .btn-row .btn{
                width:100%;
            }
            /* Votaciones mÃ³viles */
            .game-vote-card{
                padding:16px;
                margin-bottom:12px;
                min-height:70px;
                display:flex;
                flex-direction:row;
                align-items:center;
                justify-content:space-between;
                gap:12px;
            }
            .game-vote-card > div:first-child{
                display:flex;
                align-items:center;
                gap:12px;
                flex:1;
            }
            .game-vote-card > div:last-child{
                flex-shrink:0;
            }
            .vote-name{
                font-size:16px;
                font-weight:600;
            }
            .vote-chip{
                font-size:13px;
                padding:8px 14px;
                background:var(--accent-soft);
                border-radius:8px;
                white-space:nowrap;
            }
            .vote-count-badge{
                min-width:40px;
                height:32px;
                font-size:18px;
                padding:4px 10px;
                flex-shrink:0;
            }
            #vote-cards{
                max-height:65vh;
                overflow-y:auto;
                -webkit-overflow-scrolling:touch;
                padding:4px;
            }
            #vote-section{
                display:block !important;
            }
            /* EstadÃ­sticas mÃ³viles */
            .game-result-subtitle > div[style*="grid-template-columns"]{
                grid-template-columns:repeat(2,1fr) !important;
                gap:6px !important;
            }
            /* Temporizador mÃ³vil */
            #phase-timer{
                padding:8px;
            }
            #timer-display{
                font-size:20px !important;
            }
            #send-vote-btn{
                width:100%;
                min-height:50px;
                font-size:16px;
                margin-top:12px;
            }
            /* Lista de pistas mÃ³vil */
            #clues-list{
                max-height:40vh;
                overflow-y:auto;
                -webkit-overflow-scrolling:touch;
            }
            /* Chat mÃ³vil */
            #chat-list{
                max-height:30vh;
                overflow-y:auto;
                -webkit-overflow-scrolling:touch;
            }
            /* Modal de votaciÃ³n preliminar mÃ³vil */
            .vote-prompt-content{
                width:90%;
                max-width:400px;
                padding:24px 20px;
            }
            .vote-prompt-title{
                font-size:20px;
            }
            .vote-prompt-btn{
                min-height:50px;
                font-size:16px;
                padding:14px 20px;
            }
            /* Modal de resultado mÃ³vil */
            .game-result-content{
                width:90%;
                max-width:400px;
                padding:24px 20px;
                max-height:90vh;
            }
            .game-result-icon{
                font-size:50px;
            }
            .game-result-title{
                font-size:24px;
            }
            .game-result-subtitle{
                font-size:13px;
            }
            .game-result-btn{
                min-height:50px;
                font-size:15px;
                padding:12px 20px;
            }
            /* Panel de juego mÃ³vil */
            #game-phase-panel{
                padding:12px;
            }
            .phase-summary{
                font-size:13px;
            }
            /* Lista de jugadores mÃ³vil */
            .player-list{
                max-height:40vh;
                overflow-y:auto;
                -webkit-overflow-scrolling:touch;
            }
            .player-item{
                padding:10px;
                min-height:44px;
            }
        }
        
        @media(max-width:480px){
            .app{
                padding:12px;
            }
            .card{
                padding:12px;
            }
            .title-text h1{
                font-size:16px;
            }
            .game-vote-card{
                padding:14px;
            }
            .vote-name{
                font-size:15px;
            }
        }
        .card{
            background:linear-gradient(135deg, var(--card-bg) 0%, rgba(255,255,255,0.8) 100%);
            border-radius:20px;
            border:2px solid rgba(255,255,255,0.5);
            padding:24px;
            box-shadow:0 8px 32px rgba(0,0,0,0.1),
                       0 0 0 1px rgba(255,255,255,0.1) inset;
            transition:all 0.3s ease;
            position:relative;
            overflow:hidden;
        }
        .card::before{
            content:'';
            position:absolute;
            top:0;
            left:0;
            right:0;
            height:4px;
            background:linear-gradient(90deg, #667eea, #764ba2, #f093fb, #4facfe);
            opacity:0.6;
        }
        [data-theme="dark"] .card{
            background:linear-gradient(135deg, var(--card-bg) 0%, rgba(30,41,59,0.9) 100%);
            border-color:rgba(59,130,246,0.3);
        }
        [data-theme="dark"] .card::before{
            background:linear-gradient(90deg, #22c55e, #3b82f6, #8b5cf6, #22c55e);
        }
        .card h2{
            margin:0 0 16px;
            font-size:18px;
            font-weight:700;
            display:flex;
            align-items:center;
            gap:12px;
            color:var(--text-main);
            text-transform:none;
            letter-spacing:0;
        }
        .card h2 span.icon{
            font-size:24px;
            filter:drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        .card h2 span.icon{font-size:18px}
        .card small{
            display:block;
            margin-bottom:10px;
            font-size:12px;
            color:var(--text-muted);
        }
        label{
            display:block;
            font-size:13px;
            margin-bottom:4px;
        }
        input[type=text],input[type=number],select{
            width:100%;
            border-radius:10px;
            border:2px solid var(--border);
            padding:10px 12px;
            margin-bottom:8px;
            background:var(--card-bg);
            color:var(--text-main);
            font-family:inherit;
            font-size:14px;
            outline:none;
            transition:all 0.2s ease;
        }
        input:focus,select:focus{
            border-color:var(--accent);
            background:var(--card-bg);
            box-shadow:0 0 0 3px var(--accent-soft);
            transform:translateY(-1px);
        }
        [data-theme="dark"] input[type=text],[data-theme="dark"] input[type=number],[data-theme="dark"] select{
            background:#0f172a;
        }
        input::placeholder{color:#9ca3af}
        input.clue-contains-secret-word{
            border-color:#ef4444 !important;
            background:rgba(239,68,68,0.1) !important;
            color:#b91c1c !important;
            box-shadow:0 0 0 3px rgba(239,68,68,0.2) !important;
        }
        input.clue-contains-secret-word::placeholder{
            color:#dc2626;
        }
        /* Estilos para el slider de volumen */
        input[type="range"]{
            -webkit-appearance:none;
            appearance:none;
            background:transparent;
            cursor:pointer;
        }
        input[type="range"]::-webkit-slider-track{
            background:var(--border);
            height:6px;
            border-radius:3px;
        }
        input[type="range"]::-webkit-slider-thumb{
            -webkit-appearance:none;
            appearance:none;
            background:var(--accent);
            height:16px;
            width:16px;
            border-radius:50%;
            margin-top:-5px;
            box-shadow:0 2px 6px rgba(34,197,94,0.3);
            transition:all 0.2s ease;
        }
        input[type="range"]::-webkit-slider-thumb:hover{
            transform:scale(1.2);
            box-shadow:0 3px 10px rgba(34,197,94,0.5);
        }
        input[type="range"]::-moz-range-track{
            background:var(--border);
            height:6px;
            border-radius:3px;
        }
        input[type="range"]::-moz-range-thumb{
            background:var(--accent);
            height:16px;
            width:16px;
            border-radius:50%;
            border:none;
            box-shadow:0 2px 6px rgba(34,197,94,0.3);
            cursor:pointer;
            transition:all 0.2s ease;
        }
        input[type="range"]::-moz-range-thumb:hover{
            transform:scale(1.2);
            box-shadow:0 3px 10px rgba(34,197,94,0.5);
        }
        .row{display:flex;gap:10px;flex-wrap:wrap}
        .row>div{flex:1 1 0}
        .btn{
            border-radius:12px;
            border:none;
            padding:10px 18px;
            font-size:13px;
            font-weight:600;
            cursor:pointer;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:6px;
            letter-spacing:.05em;
            text-transform:uppercase;
            transition:all 0.2s ease;
            white-space:nowrap;
            position:relative;
            overflow:hidden;
        }
        .btn::before{
            content:'';
            position:absolute;
            top:50%;
            left:50%;
            width:0;
            height:0;
            border-radius:50%;
            background:rgba(255,255,255,0.2);
            transform:translate(-50%,-50%);
            transition:width 0.3s,height 0.3s;
        }
        .btn:hover::before{
            width:300px;
            height:300px;
        }
        .btn-primary{
            background:linear-gradient(135deg,#4ade80,#22c55e);
            color:#052e16;
            box-shadow:0 4px 12px rgba(34,197,94,0.4),0 2px 4px rgba(34,197,94,0.2);
        }
        .btn-primary:hover{
            transform:translateY(-2px);
            box-shadow:0 6px 20px rgba(34,197,94,0.5),0 4px 8px rgba(34,197,94,0.3);
        }
        .btn-primary:active{
            transform:translateY(0);
        }
        [data-theme="dark"] .btn-primary{
            color:#dcfce7;
        }
        .btn-secondary{
            background:var(--card-bg);
            color:var(--text-main);
            border:2px solid var(--border);
            box-shadow:0 2px 6px rgba(0,0,0,0.1);
        }
        .btn-secondary:hover{
            background:var(--accent-soft);
            border-color:var(--accent);
            transform:translateY(-1px);
            box-shadow:0 4px 12px rgba(0,0,0,0.15);
        }
        .btn-ghost{
            background:transparent;
            color:var(--text-muted);
            border:2px dashed var(--border);
        }
        .btn-ghost:hover{
            background:var(--accent-soft);
            border-color:var(--accent);
            color:var(--accent);
        }
        .btn:disabled{
            opacity:.45;cursor:not-allowed;transform:none;box-shadow:none;
        }
        .btn-row{
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:8px;
            margin-top:6px;
            flex-wrap:wrap;
        }
        .status{
            font-size:12px;
            color:var(--text-muted);
        }
        .status-chip{
            border-radius:999px;
            padding:3px 9px;
            font-size:11px;
            display:inline-flex;
            align-items:center;
            gap:6px;
        }
        .status-chip span.dot{
            width:6px;height:6px;border-radius:999px;background-color:currentColor;
        }
        .status-wait{background:var(--info-soft);color:#1d4ed8;}
        .status-ok{background:var(--accent-soft);color:#15803d;}
        .status-error{background:var(--danger-soft);color:#b91c1c;}
        .hint{
            font-size:11px;
            color:var(--text-muted);
            margin-top:4px;
        }
        .separator{
            height:1px;
            background:var(--border);
            margin:8px 0;
        }
        .player-list{
            border-radius:12px;
            border:1px solid var(--border);
            padding:8px;
            background-color:var(--card-bg);
            max-height:150px;
            overflow-y:auto;
            font-size:13px;
            transition:background 0.3s ease;
        }
        [data-theme="dark"] .player-list{
            background-color:#0f172a;
        }
        .player-item{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:6px;
            padding:4px 4px;
            border-radius:8px;
        }
        .player-item span.name{font-size:13px;}
        .player-item span.me{font-size:11px;color:#16a34a;margin-left:4px;}
        .player-dot{
            width:10px;height:10px;border-radius:999px;
            background:#22c55e;
            margin-right:4px;
        }
        .chip-small{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            padding:2px 8px;
            border-radius:999px;
            font-size:10px;
            letter-spacing:.08em;
            text-transform:uppercase;
        }
        .chip-host{background:var(--accent-soft);color:#166534;margin-left:6px;}
        .chip-dead{background:var(--danger-soft);color:#b91c1c;margin-left:6px;}
        .player-role-card{
            border-radius:14px;
            border:1px solid var(--border);
            padding:12px;
            background-color:var(--card-bg);
            margin-top:4px;
            transition:background 0.3s ease;
        }
        [data-theme="dark"] .player-role-card{
            background-color:#0f172a;
        }
        .role-label{
            font-size:12px;
            text-transform:uppercase;
            letter-spacing:.08em;
            color:var(--text-muted);
        }
        .role-main{
            font-size:18px;
            font-weight:600;
            margin-top:4px;
        }
        .role-impostor{color:#b91c1c;}
        .role-normal{color:#15803d;}
        .role-extra{
            margin-top:6px;
            font-size:13px;
            color:var(--text-muted);
        }
        .secret-word{font-size:20px;font-weight:600;margin-top:4px;}
        .room-code-box{
            border-radius:12px;
            padding:8px 10px;
            background-color:var(--card-bg);
            border:1px solid var(--border);
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:8px;
            margin-bottom:6px;
            transition:background 0.3s ease;
        }
        [data-theme="dark"] .room-code-box{
            background-color:#0f172a;
        }
        .room-code-main{font-size:14px;}
        .room-code-value{
            font-size:18px;
            font-weight:700;
            letter-spacing:.18em;
        }
        .warning{
            font-size:11px;
            color:#b91c1c;
            margin-top:4px;
        }
        #game-phase-panel{
            border-radius:14px;
            border:1px solid var(--border);
            padding:10px 10px 8px;
            background-color:var(--card-bg);
            margin-top:8px;
            transition:background 0.3s ease;
        }
        [data-theme="dark"] #game-phase-panel{
            background-color:#0f172a;
        }
        .theme-toggle{
            position:fixed;
            top:20px;
            right:20px;
            z-index:1000;
            background:var(--card-bg);
            border:2px solid var(--border);
            border-radius:50%;
            width:50px;
            height:50px;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            font-size:24px;
            box-shadow:0 4px 12px rgba(0,0,0,0.15);
            transition:all 0.3s ease;
        }
        .theme-toggle:hover{
            transform:scale(1.1) rotate(15deg);
            box-shadow:0 6px 20px rgba(0,0,0,0.25);
        }
        .spectator-section{
            border-radius:14px;
            border:2px dashed var(--border);
            padding:12px;
            background:var(--info-soft);
            margin-top:8px;
        }
        [data-theme="dark"] .spectator-section{
            background:rgba(59,130,246,0.15);
        }
        .timer-settings-card{
            border-radius:12px;
            border:1px solid var(--border);
            padding:12px;
            margin-top:12px;
            background:var(--card-bg);
        }
        .timer-settings-card.disabled{
            opacity:0.6;
        }
        .timer-settings-card .row>div{
            display:flex;
            flex-direction:column;
            gap:6px;
        }
        .timer-settings-card label{
            font-size:12px;
            text-transform:none;
            letter-spacing:0;
        }
        #clues-list,#chat-list{
            max-height:120px;
        }
        /* Toast Notifications */
        .toast-container{
            position:fixed;
            top:80px;
            right:20px;
            z-index:2000;
            display:flex;
            flex-direction:column;
            gap:10px;
            pointer-events:none;
        }
        .toast{
            background:var(--card-bg);
            border:2px solid var(--border);
            border-radius:12px;
            padding:14px 18px;
            min-width:280px;
            max-width:400px;
            box-shadow:0 8px 24px rgba(0,0,0,0.2);
            display:flex;
            align-items:center;
            gap:12px;
            animation:slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            pointer-events:auto;
            cursor:pointer;
        }
        .toast-icon{
            font-size:24px;
            flex-shrink:0;
        }
        .toast-content{
            flex:1;
        }
        .toast-title{
            font-weight:600;
            font-size:14px;
            color:var(--text-main);
            margin-bottom:2px;
        }
        .toast-message{
            font-size:12px;
            color:var(--text-muted);
        }
        .toast-success{border-left:4px solid var(--accent);}
        .toast-error{border-left:4px solid var(--danger);}
        .toast-info{border-left:4px solid #3b82f6;}
        @keyframes slideInRight{
            from{transform:translateX(400px);opacity:0;}
            to{transform:translateX(0);opacity:1;}
        }
        @keyframes fadeOut{
            to{opacity:0;transform:translateX(400px);}
        }
        /* Connection Indicator */
        .connection-indicator{
            position:fixed;
            bottom:20px;
            left:20px;
            z-index:1000;
            display:flex;
            align-items:center;
            gap:8px;
            background:var(--card-bg);
            border:2px solid var(--border);
            border-radius:20px;
            padding:8px 14px;
            font-size:12px;
            box-shadow:0 4px 12px rgba(0,0,0,0.15);
            transition:all 0.3s ease;
        }
        .connection-dot{
            width:10px;
            height:10px;
            border-radius:50%;
            background:#22c55e;
            animation:pulse 2s infinite;
        }
        .connection-dot.disconnected{
            background:#ef4444;
            animation:none;
        }
        @keyframes pulse{
            0%,100%{opacity:1;transform:scale(1);}
            50%{opacity:0.7;transform:scale(1.2);}
        }
        /* Player Count Badge */
        .player-count-badge{
            display:inline-flex;
            align-items:center;
            gap:6px;
            background:var(--accent-soft);
            color:var(--accent);
            padding:4px 10px;
            border-radius:12px;
            font-size:11px;
            font-weight:600;
            margin-left:8px;
        }
        /* Animations */
        @keyframes bounce{
            0%,100%{transform:translateY(0);}
            50%{transform:translateY(-5px);}
        }
        .animate-bounce{animation:bounce 0.5s ease;}
        @keyframes shake{
            0%,100%{transform:translateX(0);}
            25%{transform:translateX(-5px);}
            75%{transform:translateX(5px);}
        }
        .animate-shake{animation:shake 0.4s ease;}
        @keyframes pulse-glow{
            0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,0.7);}
            50%{box-shadow:0 0 0 8px rgba(34,197,94,0);}
        }
        .animate-pulse-glow{animation:pulse-glow 1.5s infinite;}
        /* Improved Cards */
        .card{
            transition:transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover{
            transform:translateY(-2px);
            box-shadow:0 12px 32px rgba(0,0,0,0.15),
                       0 0 0 1px rgba(34,197,94,0.1) inset;
        }
        [data-theme="dark"] .card:hover{
            box-shadow:0 12px 32px rgba(0,0,0,0.4),
                       0 0 0 1px rgba(34,197,94,0.2) inset;
        }
        /* Loading Spinner */
        .spinner{
            width:20px;
            height:20px;
            border:3px solid var(--border);
            border-top-color:var(--accent);
            border-radius:50%;
            animation:spin 0.8s linear infinite;
            display:inline-block;
        }
        @keyframes spin{
            to{transform:rotate(360deg);}
        }
        @keyframes scaleIn{
            from{transform:translate(-50%,-50%) scale(0.5);opacity:0;}
            to{transform:translate(-50%,-50%) scale(1);opacity:1;}
        }
        @keyframes particleFloat{
            0%{transform:translate(0,0) scale(1);opacity:1;}
            100%{transform:translate(var(--particle-x, 0px), var(--particle-y, 0px)) scale(0);opacity:0;}
        }
        @keyframes slideUp{
            from{transform:translateY(20px);opacity:0;}
            to{transform:translateY(0);opacity:1;}
        }
        @keyframes shake{
            0%,100%{transform:translateX(0);}
            10%,30%,50%,70%,90%{transform:translateX(-5px);}
            20%,40%,60%,80%{transform:translateX(5px);}
        }
        /* Improved Vote Cards */
        .vote-card{
            position:relative;
            overflow:hidden;
        }
        .vote-card::before{
            content:'';
            position:absolute;
            top:0;
            left:-100%;
            width:100%;
            height:100%;
            background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);
            transition:left 0.5s;
        }
        .vote-card:hover::before{
            left:100%;
        }
        /* Smooth Transitions */
        .player-item{
            transition:background 0.2s ease, transform 0.2s ease;
        }
        .player-item:hover{
            background:var(--accent-soft);
            transform:translateX(4px);
        }
        .clue-item-name{font-weight:600;margin-right:4px;}
        .clue-item-text{color:var(--text-main);}
        
        /* Collapsible Sections */
        .collapsible-header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            cursor:pointer;
            padding:12px 16px;
            background:linear-gradient(135deg, var(--accent-soft), rgba(255,255,255,0.1));
            border-radius:12px;
            margin:12px 0;
            transition:all 0.3s ease;
            user-select:none;
            border:1px solid var(--border);
        }
        .collapsible-header:hover{
            background:linear-gradient(135deg, var(--accent-soft), rgba(255,255,255,0.2));
            transform:translateX(4px);
            box-shadow:0 4px 12px rgba(0,0,0,0.1);
        }
        .collapsible-header.active{
            background:linear-gradient(135deg, var(--accent-soft), var(--accent-soft));
            border-color:var(--accent);
        }
        .collapsible-title{
            display:flex;
            align-items:center;
            gap:10px;
            font-weight:600;
            font-size:15px;
            color:var(--text-main);
        }
        .collapsible-icon{
            font-size:18px;
            transition:transform 0.3s ease;
        }
        .collapsible-header.active .collapsible-icon{
            transform:rotate(180deg);
        }
        .collapsible-content{
            max-height:0;
            overflow:hidden;
            transition:max-height 0.4s ease, padding 0.4s ease;
            padding:0 16px;
        }
        .collapsible-content.open{
            max-height:2000px;
            padding:16px;
        }
        .collapsible-content-inner{
            background:rgba(255,255,255,0.5);
            border-radius:12px;
            padding:16px;
            border:1px solid var(--border);
            margin-top:8px;
        }
        [data-theme="dark"] .collapsible-content-inner{
            background:rgba(15,23,42,0.5);
        }
        
        /* Decorative Elements */
        .decorative-divider{
            height:2px;
            background:linear-gradient(90deg, transparent, var(--accent), transparent);
            margin:20px 0;
            border-radius:2px;
            position:relative;
        }
        .decorative-divider::before,
        .decorative-divider::after{
            content:'âœ¦';
            position:absolute;
            top:50%;
            transform:translateY(-50%);
            color:var(--accent);
            font-size:12px;
            background:var(--card-bg);
            padding:0 8px;
        }
        .decorative-divider::before{
            left:20%;
        }
        .decorative-divider::after{
            right:20%;
        }
        
        /* Enhanced Icons */
        .icon-wrapper{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            width:40px;
            height:40px;
            border-radius:12px;
            background:linear-gradient(135deg, var(--accent-soft), rgba(255,255,255,0.1));
            border:1px solid var(--border);
            box-shadow:0 4px 12px rgba(0,0,0,0.1);
        }
        
        /* Better Inputs */
        input[type=text],input[type=number],select{
            background:rgba(255,255,255,0.8);
            border:2px solid var(--border);
            box-shadow:0 2px 8px rgba(0,0,0,0.05);
        }
        input:focus,select:focus{
            background:rgba(255,255,255,1);
            box-shadow:0 0 0 4px var(--accent-soft),
                       0 4px 16px rgba(34,197,94,0.2);
        }
        [data-theme="dark"] input[type=text],[data-theme="dark"] input[type=number],[data-theme="dark"] select{
            background:rgba(15,23,42,0.8);
        }
        [data-theme="dark"] input:focus,[data-theme="dark"] select:focus{
            background:rgba(15,23,42,1);
        }
        
        /* Enhanced Buttons */
        .btn-primary{
            background:linear-gradient(135deg, #4ade80 0%, #22c55e 50%, #16a34a 100%);
            box-shadow:0 6px 20px rgba(34,197,94,0.4),
                       0 0 0 1px rgba(255,255,255,0.1) inset;
        }
        .btn-primary:hover{
            box-shadow:0 8px 28px rgba(34,197,94,0.5),
                       0 0 0 1px rgba(255,255,255,0.2) inset;
            transform:translateY(-2px) scale(1.02);
        }
        
        /* Room Code Display Enhancement */
        .room-code-value{
            background:linear-gradient(135deg, var(--accent-soft), rgba(255,255,255,0.1));
            padding:14px 24px;
            border-radius:16px;
            border:2px solid var(--accent);
            box-shadow:0 6px 20px rgba(34,197,94,0.4),
                       0 0 30px rgba(34,197,94,0.15),
                       0 0 0 1px rgba(255,255,255,0.1) inset;
            letter-spacing:0.25em;
            display:inline-block;
            margin-top:8px;
            font-size:20px;
            animation:pulse-glow 2s ease-in-out infinite;
        }
        
        /* Player List Enhancement */
        .player-list{
            background:rgba(255,255,255,0.7);
            border:2px solid var(--border);
            box-shadow:inset 0 2px 8px rgba(0,0,0,0.05),
                       0 2px 8px rgba(0,0,0,0.05);
            transition:all 0.3s ease;
        }
        .player-list:hover{
            background:rgba(255,255,255,0.85);
            box-shadow:inset 0 2px 8px rgba(0,0,0,0.08),
                       0 4px 12px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] .player-list{
            background:rgba(15,23,42,0.7);
        }
        [data-theme="dark"] .player-list:hover{
            background:rgba(15,23,42,0.85);
        }
        
        /* Status Chip Enhancement */
        .status-chip{
            box-shadow:0 2px 8px rgba(0,0,0,0.1);
            border:1px solid rgba(255,255,255,0.2);
        }
        
        /* Title Enhancement */
        .title-icon{
            background:linear-gradient(135deg, #22c55e 0%, #16a34a 50%, #15803d 100%);
            box-shadow:0 8px 24px rgba(34,197,94,0.4),
                       0 0 0 2px rgba(255,255,255,0.1) inset;
            animation:float 3s ease-in-out infinite;
        }
        @keyframes float{
            0%,100%{transform:translateY(0px);}
            50%{transform:translateY(-5px);}
        }
        .title-text h1{
            background:linear-gradient(135deg, var(--text-main), var(--accent));
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
            font-weight:800;
            letter-spacing:0.05em;
        }
        [data-theme="dark"] .title-text h1{
            background:linear-gradient(135deg, #f1f5f9, #22c55e);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
        }
        .vote-card{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:6px;
            padding:6px 8px;
            border-radius:10px;
            border:1px solid var(--border);
            background:#ffffff;
            cursor:pointer;
            margin-bottom:4px;
            transition:background .12s,border .12s,transform .08s;
        }
        .vote-card:hover{background:#ecfeff;transform:translateY(-1px);}
        .vote-selected{border-color:#22c55e;background:#dcfce7;}
        .vote-name{font-size:13px;}
        .vote-chip{font-size:10px;color:var(--text-muted);}
        #chat-list .player-item{align-items:flex-start;}
        #chat-list .msg-text{margin-left:4px;}
        
        /* Modal para elegir modo de juego */
        .modal-overlay{
            position:fixed;
            top:0;
            left:0;
            right:0;
            bottom:0;
            background:rgba(0,0,0,0.75);
            backdrop-filter:blur(8px);
            display:flex;
            align-items:center;
            justify-content:center;
            z-index:3000;
            animation:fadeIn 0.3s ease;
        }
        @keyframes fadeIn{
            from{opacity:0;}
            to{opacity:1;}
        }
        .modal-content{
            background:var(--card-bg);
            border-radius:24px;
            padding:40px;
            max-width:600px;
            width:90%;
            box-shadow:0 25px 50px rgba(0,0,0,0.5),
                       0 0 0 1px rgba(255,255,255,0.1) inset;
            border:2px solid var(--border);
            animation:slideUp 0.4s ease;
            position:relative;
            overflow:hidden;
        }
        @keyframes slideUp{
            from{transform:translateY(30px);opacity:0;}
            to{transform:translateY(0);opacity:1;}
        }
        .modal-content::before{
            content:'';
            position:absolute;
            top:0;
            left:0;
            right:0;
            height:6px;
            background:linear-gradient(90deg, #667eea, #764ba2, #f093fb, #4facfe);
            opacity:0.8;
        }
        [data-theme="dark"] .modal-content::before{
            background:linear-gradient(90deg, #22c55e, #3b82f6, #8b5cf6, #22c55e);
        }
        .modal-title{
            font-size:28px;
            font-weight:800;
            margin-bottom:12px;
            background:linear-gradient(135deg, var(--text-main), var(--accent));
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
            text-align:center;
        }
        .modal-subtitle{
            font-size:14px;
            color:var(--text-muted);
            text-align:center;
            margin-bottom:32px;
        }
        .mode-selection{
            display:grid;
            grid-template-columns:1fr 1fr;
            gap:20px;
            margin-bottom:24px;
        }
        @media(max-width:600px){
            .mode-selection{grid-template-columns:1fr;}
        }
        .mode-card{
            background:linear-gradient(135deg, var(--card-bg) 0%, rgba(255,255,255,0.5) 100%);
            border:3px solid var(--border);
            border-radius:20px;
            padding:28px;
            cursor:pointer;
            transition:all 0.3s ease;
            position:relative;
            overflow:hidden;
            text-align:center;
        }
        .mode-card::before{
            content:'';
            position:absolute;
            top:0;
            left:0;
            right:0;
            height:4px;
            background:var(--accent);
            transform:scaleX(0);
            transition:transform 0.3s ease;
        }
        .mode-card:hover{
            transform:translateY(-4px);
            border-color:var(--accent);
            box-shadow:0 12px 32px rgba(34,197,94,0.3);
        }
        .mode-card:hover::before{
            transform:scaleX(1);
        }
        .mode-card.selected{
            border-color:var(--accent);
            background:linear-gradient(135deg, var(--accent-soft) 0%, rgba(255,255,255,0.8) 100%);
            box-shadow:0 8px 24px rgba(34,197,94,0.4);
        }
        .mode-card.selected::before{
            transform:scaleX(1);
        }
        [data-theme="dark"] .mode-card{
            background:linear-gradient(135deg, var(--card-bg) 0%, rgba(30,41,59,0.8) 100%);
        }
        [data-theme="dark"] .mode-card.selected{
            background:linear-gradient(135deg, var(--accent-soft) 0%, rgba(15,23,42,0.9) 100%);
        }
        .mode-icon{
            font-size:48px;
            margin-bottom:16px;
            display:block;
        }
        .mode-title{
            font-size:20px;
            font-weight:700;
            margin-bottom:8px;
            color:var(--text-main);
        }
        .mode-description{
            font-size:13px;
            color:var(--text-muted);
            line-height:1.5;
            margin-bottom:12px;
        }
        .mode-tooltip{
            position:absolute;
            bottom:100%;
            left:50%;
            transform:translateX(-50%);
            background:var(--text-main);
            color:var(--card-bg);
            padding:12px 16px;
            border-radius:12px;
            font-size:12px;
            white-space:nowrap;
            opacity:0;
            pointer-events:none;
            transition:opacity 0.3s ease, transform 0.3s ease;
            margin-bottom:8px;
            box-shadow:0 8px 24px rgba(0,0,0,0.3);
            z-index:10;
        }
        .mode-tooltip::after{
            content:'';
            position:absolute;
            top:100%;
            left:50%;
            transform:translateX(-50%);
            border:6px solid transparent;
            border-top-color:var(--text-main);
        }
        .mode-card:hover .mode-tooltip{
            opacity:1;
            transform:translateX(-50%) translateY(-4px);
        }
        .modal-actions{
            display:flex;
            gap:12px;
            justify-content:center;
        }
        .modal-btn{
            padding:12px 32px;
            font-size:15px;
            font-weight:600;
        }
        
        /* Estilos separados para la partida */
        .game-phase-container{
            background:linear-gradient(135deg, rgba(34,197,94,0.05) 0%, rgba(59,130,246,0.05) 100%);
            border-radius:20px;
            padding:24px;
            border:2px solid rgba(34,197,94,0.2);
            margin-top:16px;
            position:relative;
            overflow:hidden;
        }
        .game-phase-container::before{
            content:'';
            position:absolute;
            top:0;
            left:0;
            right:0;
            height:3px;
            background:linear-gradient(90deg, #22c55e, #3b82f6, #8b5cf6, #22c55e);
            background-size:200% 100%;
            animation:gradientMove 3s linear infinite;
        }
        @keyframes gradientMove{
            0%{background-position:0% 50%;}
            100%{background-position:200% 50%;}
        }
        [data-theme="dark"] .game-phase-container{
            background:linear-gradient(135deg, rgba(34,197,94,0.1) 0%, rgba(59,130,246,0.1) 100%);
            border-color:rgba(34,197,94,0.3);
        }
        .game-phase-title{
            font-size:20px;
            font-weight:700;
            margin-bottom:16px;
            display:flex;
            align-items:center;
            gap:10px;
            color:var(--text-main);
        }
        .game-phase-title::before{
            content:'ðŸŽ®';
            font-size:24px;
        }
        .game-clue-item{
            background:rgba(255,255,255,0.7);
            border:2px solid var(--border);
            border-radius:12px;
            padding:12px 16px;
            margin-bottom:8px;
            transition:all 0.2s ease;
        }
        .game-clue-item:hover{
            background:rgba(255,255,255,0.9);
            transform:translateX(4px);
            box-shadow:0 4px 12px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] .game-clue-item{
            background:rgba(15,23,42,0.7);
        }
        [data-theme="dark"] .game-clue-item:hover{
            background:rgba(15,23,42,0.9);
        }
        /* Estilo minimalista cartoon para votaciÃ³n */
        .game-vote-card{
            background:var(--card-bg);
            border:3px solid var(--border);
            border-radius:16px;
            padding:16px 20px;
            margin-bottom:12px;
            cursor:pointer;
            transition:all 0.2s ease;
            position:relative;
            display:flex;
            align-items:center;
            justify-content:space-between;
            box-shadow:0 2px 8px rgba(0,0,0,0.08);
        }
        .game-vote-card:hover{
            transform:translateY(-2px) scale(1.02);
            border-color:var(--accent);
            box-shadow:0 4px 16px rgba(34,197,94,0.2);
        }
        .game-vote-card.selected{
            background:var(--accent-soft);
            border-color:var(--accent);
            border-width:3px;
            box-shadow:0 0 0 2px var(--accent),
                       0 4px 16px rgba(34,197,94,0.3);
            animation:selectedPulse 1.5s ease-in-out infinite;
        }
        @keyframes selectedPulse{
            0%,100%{transform:scale(1);}
            50%{transform:scale(1.02);}
        }
        [data-theme="dark"] .game-vote-card{
            background:var(--card-bg);
            box-shadow:0 2px 8px rgba(0,0,0,0.2);
        }
        [data-theme="dark"] .game-vote-card.selected{
            background:var(--accent-soft);
            box-shadow:0 0 0 2px var(--accent),
                       0 4px 16px rgba(34,197,94,0.4);
        }
        .vote-name{
            font-size:16px;
            font-weight:600;
            color:var(--text-main);
        }
        .vote-chip{
            font-size:12px;
            color:var(--text-muted);
            font-weight:500;
        }
        
        /* Badge de contador de votos */
        .vote-count-badge{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            min-width:32px;
            height:24px;
            padding:4px 8px;
            background:var(--accent);
            color:#ffffff;
            border-radius:12px;
            font-size:14px;
            font-weight:700;
            font-family:'Inter',system-ui,sans-serif;
            box-shadow:0 2px 8px rgba(34,197,94,0.3);
            animation:votePulse 0.5s ease;
        }
        @keyframes votePulse{
            0%{transform:scale(0.8);opacity:0;}
            50%{transform:scale(1.1);}
            100%{transform:scale(1);opacity:1;}
        }
        [data-theme="dark"] .vote-count-badge{
            background:var(--accent);
            box-shadow:0 2px 8px rgba(34,197,94,0.4);
        }
        
        /* Ventana intermitente de votaciÃ³n - Estilo minimalista cartoon */
        .vote-prompt-modal{
            position:fixed;
            top:0;
            left:0;
            right:0;
            bottom:0;
            background:rgba(0,0,0,0.4);
            backdrop-filter:blur(4px);
            display:flex;
            align-items:center;
            justify-content:center;
            z-index:4000;
            animation:fadeIn 0.3s ease;
        }
        @keyframes fadeIn{
            from{opacity:0;}
            to{opacity:1;}
        }
        @keyframes bounce{
            0%,100%{transform:translateY(0) scale(1);}
            50%{transform:translateY(-8px) scale(1.02);}
        }
        .vote-prompt-content{
            background:var(--card-bg);
            border-radius:20px;
            padding:32px 28px;
            max-width:420px;
            width:90%;
            box-shadow:0 8px 32px rgba(0,0,0,0.15),
                       0 0 0 4px var(--accent);
            border:none;
            text-align:center;
            animation:bounce 2s ease-in-out infinite;
            position:relative;
            overflow:hidden;
        }
        .vote-prompt-content::before{
            content:"";
            position:absolute;
            top:-50%;
            left:-50%;
            width:200%;
            height:200%;
            background:radial-gradient(circle, rgba(34,197,94,0.1) 0%, transparent 70%);
            animation:rotate 8s linear infinite;
        }
        @keyframes rotate{
            from{transform:rotate(0deg);}
            to{transform:rotate(360deg);}
        }
        .vote-prompt-title{
            font-size:24px;
            font-weight:700;
            margin-bottom:12px;
            color:var(--text-main);
            position:relative;
            z-index:1;
        }
        .vote-prompt-text{
            font-size:14px;
            color:var(--text-muted);
            margin-bottom:20px;
            line-height:1.5;
            position:relative;
            z-index:1;
        }
        .vote-prompt-timer{
            font-size:56px;
            font-weight:800;
            color:var(--accent);
            margin:16px 0;
            position:relative;
            z-index:1;
            font-family:'Inter',system-ui,sans-serif;
            text-shadow:0 2px 8px rgba(34,197,94,0.2);
            animation:pulse-timer 1s ease-in-out infinite;
        }
        @keyframes pulse-timer{
            0%,100%{transform:scale(1);}
            50%{transform:scale(1.1);}
        }
        .vote-prompt-buttons{
            display:flex;
            gap:12px;
            justify-content:center;
            position:relative;
            z-index:1;
        }
        .vote-prompt-btn{
            padding:12px 28px;
            font-size:15px;
            font-weight:600;
            border-radius:16px;
            cursor:pointer;
            transition:all 0.2s ease;
            border:none;
            font-family:'Inter',system-ui,sans-serif;
        }
        .vote-prompt-btn-yes{
            background:var(--accent);
            color:#ffffff;
            box-shadow:0 4px 12px rgba(34,197,94,0.3);
        }
        .vote-prompt-btn-yes:hover{
            transform:translateY(-2px);
            box-shadow:0 6px 16px rgba(34,197,94,0.4);
        }
        .vote-prompt-btn-yes:active{
            transform:translateY(0);
        }
        .vote-prompt-btn-no{
            background:var(--bg);
            color:var(--text-main);
            border:2px solid var(--border);
        }
        .vote-prompt-btn-no:hover{
            background:var(--accent-soft);
            border-color:var(--accent);
        }
        .vote-prompt-btn-no:active{
            transform:scale(0.98);
        }
        
        /* Modal de resultado final - Estilo grande y llamativo */
        .game-result-modal{
            position:fixed;
            top:0;
            left:0;
            right:0;
            bottom:0;
            background:rgba(0,0,0,0.85);
            backdrop-filter:blur(10px);
            display:flex;
            align-items:center;
            justify-content:center;
            z-index:5000;
            animation:fadeIn 0.4s ease;
        }
        .game-result-content{
            background:var(--card-bg);
            border-radius:20px;
            padding:30px 24px;
            max-width:500px;
            width:85%;
            max-height:85vh;
            overflow-y:auto;
            text-align:center;
            box-shadow:0 20px 60px rgba(0,0,0,0.5),
                       0 0 0 2px var(--accent);
            border:2px solid var(--accent);
            animation:resultSlideUp 0.5s ease;
            position:relative;
        }
        @keyframes resultSlideUp{
            from{
                opacity:0;
                transform:translateY(50px) scale(0.9);
            }
            to{
                opacity:1;
                transform:translateY(0) scale(1);
            }
        }
        .game-result-icon{
            font-size:60px;
            margin-bottom:12px;
            position:relative;
            z-index:1;
            animation:bounce 2s ease-in-out infinite;
        }
        .game-result-title{
            font-size:28px;
            font-weight:700;
            margin-bottom:12px;
            color:var(--text-main);
            position:relative;
            z-index:1;
            text-shadow:0 2px 10px rgba(0,0,0,0.1);
        }
        .game-result-subtitle{
            font-size:14px;
            color:var(--text-muted);
            margin-bottom:20px;
            line-height:1.5;
            position:relative;
            z-index:1;
        }
        .game-result-buttons{
            display:flex;
            gap:16px;
            justify-content:center;
            position:relative;
            z-index:1;
        }
        .game-result-btn{
            padding:16px 40px;
            font-size:18px;
            font-weight:600;
            border-radius:16px;
            cursor:pointer;
            transition:all 0.3s ease;
            border:none;
            font-family:'Inter',system-ui,sans-serif;
        }
        .game-result-btn-primary{
            background:var(--accent);
            color:#ffffff;
            box-shadow:0 6px 20px rgba(34,197,94,0.4);
        }
        .game-result-btn-primary:hover{
            transform:translateY(-3px) scale(1.05);
            box-shadow:0 8px 28px rgba(34,197,94,0.5);
        }
        .game-result-btn-secondary{
            background:var(--bg);
            color:var(--text-main);
            border:3px solid var(--border);
        }
        .game-result-btn-secondary:hover{
            background:var(--accent-soft);
            border-color:var(--accent);
            transform:translateY(-2px);
        }
        .game-result-btn:active{
            transform:scale(0.98);
        }
        
        /* Mejoras visuales para pistas */
        #clues-section .collapsible-content-inner{
            max-height:none;
            padding:20px;
        }
        #clues-list{
            max-height:500px;
            min-height:300px;
            font-size:16px;
            padding:20px;
            overflow-y:auto;
        }
        .game-clue-item{
            font-size:16px;
            padding:18px 24px;
            margin-bottom:14px;
        }
        .clue-item-name{
            font-size:17px;
            font-weight:700;
        }
        .clue-item-text{
            font-size:16px;
        }
        #clue-input{
            font-size:17px;
            padding:16px 20px;
            min-height:50px;
        }
        #send-clue-btn{
            font-size:16px;
            padding:16px 28px;
            min-height:50px;
        }
        #clue-input-row{
            margin-top:20px !important;
        }
        
        /* CrÃ©ditos discretos */
        .credits{
            position:fixed;
            bottom:10px;
            right:10px;
            font-size:10px;
            color:var(--text-muted);
            opacity:0.5;
            z-index:100;
            transition:opacity 0.3s ease;
        }
        .credits:hover{
            opacity:1;
        }
    </style>
</head>
<body>
<button class="theme-toggle" id="theme-toggle" title="Cambiar tema">ðŸŒ™</button>
<div class="toast-container" id="toast-container"></div>
<div class="connection-indicator" id="connection-indicator">
    <span class="connection-dot" id="connection-dot"></span>
    <span id="connection-text">Conectado</span>
</div>

<!-- Modal para elegir modo de juego -->
<div class="modal-overlay" id="mode-selection-modal" style="display:none;">
    <div class="modal-content">
        <h2 class="modal-title">Elige tu modo de juego</h2>
        <p class="modal-subtitle">Selecciona cÃ³mo quieres participar en la partida</p>
        <div class="mode-selection">
            <div class="mode-card" data-mode="participant">
                <span class="mode-tooltip">Juegas normalmente: recibes palabra secreta, das pistas y votas</span>
                <span class="mode-icon">ðŸŽ®</span>
                <div class="mode-title">Participante</div>
                <div class="mode-description">Juegas como un jugador normal. RecibirÃ¡s la palabra secreta (o serÃ¡s el impostor) y participarÃ¡s en todas las fases del juego.</div>
            </div>
            <div class="mode-card" data-mode="host">
                <span class="mode-tooltip">Solo diriges la partida: eliges palabra, pistas y controlas las rondas</span>
                <span class="mode-icon">ðŸ‘‘</span>
                <div class="mode-title">AnfitriÃ³n</div>
                <div class="mode-description">Diriges la partida sin jugar. Eliges la palabra secreta, das pistas al impostor y controlas el flujo del juego como espectador.</div>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-primary modal-btn" id="confirm-mode-btn" disabled>Continuar</button>
        </div>
    </div>
</div>

<!-- CrÃ©ditos discretos -->
<div class="credits">Proyecto realizado por Daniel DÃ­az Campoy</div>

<!-- Modal de votaciÃ³n intermitente -->
<div class="vote-prompt-modal" id="vote-prompt-modal" style="display:none;">
    <div class="vote-prompt-content">
        <div class="vote-prompt-title">
            <span style="display:inline-block;animation:bounce 1.5s ease-in-out infinite;">ðŸ—³ï¸</span>
            Â¿Pasar a votaciÃ³n?
        </div>
        <div class="vote-prompt-text">
            Todos han dado su pista. Â¿Quieres pasar a votaciÃ³n ahora o seguir dando pistas?
        </div>
        <div id="vote-prompt-percentages" style="margin:16px 0;padding:12px;background:rgba(255,255,255,0.1);border-radius:12px;font-size:14px;">
            <div style="margin-bottom:8px;"><strong>Votos en tiempo real:</strong></div>
            <div id="vote-yes-percent" style="color:var(--accent);margin-bottom:4px;">SÃ­: 0%</div>
            <div id="vote-no-percent" style="color:var(--text-muted);">No: 0%</div>
        </div>
        <div class="vote-prompt-timer" id="vote-prompt-timer">5</div>
        <div class="vote-prompt-buttons">
            <button class="vote-prompt-btn vote-prompt-btn-yes" id="vote-prompt-yes">SÃ­, votar</button>
            <button class="vote-prompt-btn vote-prompt-btn-no" id="vote-prompt-no">Seguir pistas</button>
        </div>
    </div>
</div>

<!-- Modal de resultado final -->
<div class="game-result-modal" id="game-result-modal" style="display:none;">
    <div class="game-result-content">
        <div class="game-result-icon" id="game-result-icon">ðŸŽ‰</div>
        <div class="game-result-title" id="game-result-title">Â¡Partida terminada!</div>
        <div class="game-result-subtitle" id="game-result-subtitle"></div>
        <div class="game-result-buttons">
            <button class="game-result-btn game-result-btn-primary" id="new-game-btn">ðŸ”„ Nueva partida</button>
            <button class="game-result-btn game-result-btn-secondary" id="exit-game-btn">ðŸšª Salir</button>
        </div>
    </div>
</div>

<div class="app">
    <div class="app-inner">
        <header>
            <div class="title">
                <div class="title-icon">ðŸ•µï¸â€â™‚ï¸</div>
                <div class="title-text">
                    <h1>Juego del Impostor</h1>
                    <span>Palabra secreta, pistas y votaciÃ³n entre amigos</span>
                </div>
            </div>
            <div class="header-right">
                <div class="badge">HTML Â· Firebase Â· Realtime</div>
                <div style="display:flex;gap:6px;align-items:center;">
                    <button class="btn btn-secondary" id="music-toggle-btn" type="button" style="padding:6px 12px;font-size:11px;">
                        ðŸŽµ MÃºsica
                    </button>
                    <button class="btn btn-secondary" id="sounds-toggle-btn" type="button" style="padding:6px 12px;font-size:11px;" title="Activar/desactivar sonidos">
                        ðŸ”Š Sonidos
                    </button>
                    <div id="music-volume-control" style="display:none;align-items:center;gap:6px;padding:4px 8px;background:var(--card-bg);border-radius:8px;border:1px solid var(--border);">
                        <span style="font-size:12px;">ðŸ”‰</span>
                        <input type="range" id="music-volume-slider" min="0" max="100" value="50" style="width:80px;height:6px;cursor:pointer;">
                        <span style="font-size:12px;">ðŸ”Š</span>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <!-- IZQUIERDA: CREAR / UNIRSE + CONFIG HOST -->
            <section class="card" id="main-settings-card">
                <h2><span class="icon">ðŸŒ</span> Sala</h2>
                <small>Todos usÃ¡is este mismo HTML. Una persona crea la sala, el resto se une con el cÃ³digo.</small>

                <label for="nickname">Tu nombre</label>
                <input type="text" id="nickname" placeholder="Ej: Dani, Ana, Hugo..." />

                <div class="row" style="margin-top:10px;">
                    <div>
                        <label for="room-code-join">CÃ³digo de sala (para unirse)</label>
                        <input type="text" id="room-code-join" placeholder="Ej: ABCD" maxlength="6">
                    </div>
                </div>

                <div class="btn-row">
                    <button class="btn btn-primary" id="create-room-btn" type="button">Crear sala</button>
                    <button class="btn btn-secondary" id="join-room-btn" type="button">Unirse</button>
                </div>
                
                <div id="bot-config-section" style="margin-top:12px;display:block;">
                    <div style="display:flex;align-items:center;gap:8px;padding:12px;background:var(--accent-soft);border-radius:12px;border:2px solid var(--accent);">
                        <input type="checkbox" id="enable-bots-checkbox" style="width:18px;height:18px;cursor:pointer;">
                        <label for="enable-bots-checkbox" style="margin:0;font-size:13px;font-weight:500;cursor:pointer;flex:1;">
                            ðŸ¤– Activar bots (jugadores automÃ¡ticos)
                        </label>
                    </div>
                    <div id="bot-count-input-container" style="margin-top:8px;display:none;padding:12px;background:var(--card-bg);border-radius:12px;border:2px solid var(--border);">
                        <label for="bot-count-input" style="display:block;margin-bottom:6px;font-size:13px;font-weight:500;">
                            Â¿CuÃ¡ntos bots quieres aÃ±adir?
                        </label>
                        <input type="number" id="bot-count-input" min="1" max="10" value="2" style="width:100%;padding:8px;border-radius:8px;border:2px solid var(--border);">
                        <p class="hint" style="margin-top:6px;font-size:11px;">MÃ¡ximo 10 bots. Se generarÃ¡n automÃ¡ticamente al crear la sala.</p>
                    </div>
                </div>

                <p class="hint">Al crear una sala, podrÃ¡s elegir si juegas como participante o solo como anfitriÃ³n.</p>

                <div class="decorative-divider"></div>

                <div id="host-settings" style="display:none;">
                    <div class="collapsible-header" onclick="toggleCollapsible('host-config')">
                        <div class="collapsible-title">
                            <span class="icon">ðŸŽ›ï¸</span>
                            <span>ConfiguraciÃ³n (anfitriÃ³n)</span>
                        </div>
                        <span class="collapsible-icon">â–¼</span>
                    </div>
                    <div class="collapsible-content open" id="host-config">
                        <div class="collapsible-content-inner">
                            <small style="display:block;margin-bottom:16px;color:var(--text-muted);">El host elige palabra, pista (opcional) y arranca las rondas.</small>

                    <label for="expected-players">NÃºmero previsto de jugadores (3-15)</label>
                    <input type="number" id="expected-players" min="3" max="15" value="4">
                    <p class="hint" style="margin-top:-4px;">MÃ­nimo 3 jugadores, mÃ¡ximo 15 (sin contar host si es solo espectador)</p>

                    <div id="word-config-section">
                        <label for="secret-word">ðŸŽ¯ Palabra secreta</label>
                        <div class="row" style="align-items:flex-start;">
                            <div><input type="text" id="secret-word" placeholder="Ej: Pizza, cine, montaÃ±a..." /></div>
                            <div style="flex:0 0 auto;">
                                <button class="btn btn-ghost" id="random-word-btn" type="button" style="margin-bottom:4px;">ðŸŽ² Aleatoria</button>
                            </div>
                        </div>
                        <p class="hint">ðŸ’¡ La palabra se genera automÃ¡ticamente. Si eres solo anfitriÃ³n, se elegirÃ¡ una palabra aleatoria.</p>

                        <label for="hint" style="margin-top:6px;">Pista (si la hay)</label>
                        <input type="text" id="hint" placeholder="Algo general, que no revele demasiado" />
                    </div>

                    <div style="margin-top:12px;display:flex;align-items:center;gap:6px;">
                        <input type="checkbox" id="give-hint-checkbox" checked>
                        <label for="give-hint-checkbox" style="margin:0;font-size:13px;font-weight:500;">ðŸ’¡ Dar pista al impostor</label>
                    </div>
                    
                    <div class="timer-settings-card" id="timer-settings-card">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <input type="checkbox" id="timer-enabled-checkbox" checked>
                            <label for="timer-enabled-checkbox" style="margin:0;font-size:13px;font-weight:500;">
                                â±ï¸ Usar temporizador automÃ¡tico
                            </label>
                        </div>
                        <div class="row">
                            <div>
                                <label for="clue-timer-input">Tiempo de pistas (segundos)</label>
                                <input type="number" id="clue-timer-input" min="10" max="300" value="60">
                            </div>
                            <div>
                                <label for="vote-timer-input">Tiempo de votaciÃ³n (segundos)</label>
                                <input type="number" id="vote-timer-input" min="10" max="300" value="45">
                            </div>
                        </div>
                        <p class="hint" style="margin-top:6px;">Si todos envÃ­an su pista antes de tiempo, pasarÃ©is directamente a votaciÃ³n.</p>
                    </div>
                    
                    <div class="hint" id="participant-mode-hint" style="display:none;margin-top:12px;padding:14px;background:linear-gradient(135deg, var(--accent-soft), rgba(59,130,246,0.1));border-radius:12px;border:2px solid var(--accent);box-shadow:0 4px 12px rgba(34,197,94,0.2);">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                            <span style="font-size:20px;">ðŸŽ®</span>
                            <strong style="color:var(--accent);">Modo Participante</strong>
                        </div>
                        <div style="font-size:12px;color:var(--text-muted);line-height:1.5;">
                            La palabra se elige automÃ¡ticamente para evitar trampas. Solo puedes decidir si dar pista al impostor. Si quieres elegir la palabra, cambia a modo "AnfitriÃ³n".
                        </div>
                    </div>

                    <div class="btn-row">
                        <span class="status" id="host-status-text"></span>
                        <button class="btn btn-primary" id="start-game-btn" type="button" disabled>Empezar partida</button>
                    </div>

                    <button class="btn btn-secondary" id="start-vote-btn" type="button" style="margin-top:6px;display:none;">
                        Pasar a votaciÃ³n
                    </button>

                            <div class="warning" style="padding:12px;background:rgba(239,68,68,0.1);border-radius:10px;border-left:4px solid var(--danger);margin-top:12px;">
                                <strong style="color:var(--danger);">âš ï¸ Importante:</strong>
                                <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">
                                    Solo el anfitriÃ³n puede configurar la partida. Si eres participante, la palabra se genera automÃ¡ticamente.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- DERECHA: ESTADO, ROL, PISTAS, VOTOS, CHAT -->
            <section class="card">
                <h2><span class="icon">ðŸŽ­</span> Sala y partida</h2>
                <small id="room-status-small">Crea o Ãºnete a una sala para empezar.</small>

                <div id="room-info" style="display:none;">
                    <div class="room-code-box">
                        <div class="room-code-main">
                            CÃ³digo de sala:
                            <div class="room-code-value" id="room-code-display">----</div>
                        </div>
                        <div style="display:flex;gap:8px;">
                            <button class="btn btn-secondary" id="copy-code-btn" type="button" title="Copiar cÃ³digo">
                                ðŸ“‹ Copiar
                            </button>
                            <button class="btn btn-secondary" id="leave-room-btn" type="button">Salir</button>
                        </div>
                    </div>

                    <div class="status">
                        <span class="status-chip status-wait" id="room-phase-chip">
                            <span class="dot"></span>
                            Esperando configuraciÃ³nâ€¦
                        </span>
                    </div>

                    <div class="separator"></div>

                    <label>
                        Jugadores conectados
                        <span class="player-count-badge" id="player-count-badge" style="display:none;">
                            <span id="player-count-number">0</span> / 15
                        </span>
                    </label>
                    <div class="player-list" id="players-list"></div>

                    <div class="decorative-divider"></div>

                    <div class="collapsible-header" onclick="toggleCollapsible('role-section')" id="role-header" style="display:none;">
                        <div class="collapsible-title">
                            <span class="icon">ðŸŽ­</span>
                            <span>Tu rol en la partida</span>
                        </div>
                        <span class="collapsible-icon">â–¼</span>
                    </div>
                    <div class="collapsible-content open" id="role-section" style="display:none;">
                        <div class="collapsible-content-inner">
                            <div class="player-role-card" id="role-card" style="display:none;">
                                <div class="role-label">Tu rol</div>
                                <div class="role-main" id="role-main-text">-</div>
                                <div class="role-extra" id="role-extra-text"></div>
                            </div>

                            <div class="spectator-section" id="spectator-section" style="display:none;">
                                <div class="role-label">ðŸ‘ï¸ Eres espectador</div>
                                <div style="margin-top:8px;font-size:13px;color:var(--text-muted);">
                                    Como espectador, puedes ver la palabra secreta para seguir la partida:
                                </div>
                                <div class="secret-word" id="spectator-word" style="margin-top:8px;color:var(--accent);">-</div>
                                <div style="margin-top:8px;font-size:12px;color:var(--text-muted);">
                                    Observa las pistas y votaciones para disfrutar del juego.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="game-phase-panel" class="game-phase-container" style="display:none;">
                        <div id="phase-summary" class="hint" style="padding:12px;background:var(--accent-soft);border-radius:12px;margin-bottom:16px;"></div>
                        <div id="phase-timer" style="display:none;padding:10px;background:var(--card-bg);border-radius:10px;border:2px solid var(--accent);margin-bottom:12px;text-align:center;">
                            <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">â±ï¸ Tiempo restante</div>
                            <div id="timer-display" style="font-size:24px;font-weight:700;color:var(--accent);">--:--</div>
                        </div>

                        <div class="collapsible-header" onclick="toggleCollapsible('clues-section')">
                            <div class="collapsible-title">
                                <span class="icon">ðŸ’¡</span>
                                <span>Pistas de la ronda</span>
                            </div>
                            <span class="collapsible-icon">â–¼</span>
                        </div>
                        <div class="collapsible-content open" id="clues-section">
                            <div class="collapsible-content-inner">
                                <div class="player-list" id="clues-list"></div>
                                <div id="clue-input-row" class="btn-row" style="margin-top:12px;">
                                    <input type="text" id="clue-input" placeholder="Escribe tu pista..." style="flex:1;margin-bottom:0;">
                                    <button class="btn btn-primary" id="send-clue-btn" type="button">Enviar</button>
                                </div>
                                <p class="hint" id="clue-hint-text" style="margin-top:8px;"></p>
                            </div>
                        </div>

                        <div class="decorative-divider"></div>

                        <div class="collapsible-header" onclick="toggleCollapsible('vote-section')" id="vote-header" style="display:none;">
                            <div class="collapsible-title">
                                <span class="icon">ðŸ—³ï¸</span>
                                <span>VotaciÃ³n</span>
                            </div>
                            <span class="collapsible-icon">â–¼</span>
                        </div>
                        <div class="collapsible-content open" id="vote-section" style="display:none;">
                            <div class="collapsible-content-inner">
                                <div id="vote-cards" class="player-list"></div>
                                <div class="btn-row" style="margin-top:12px;">
                                    <button class="btn btn-primary" id="send-vote-btn" type="button">Confirmar voto</button>
                                </div>
                                <p class="hint" id="vote-hint-text" style="margin-top:8px;"></p>
                            </div>
                        </div>

                        <div class="decorative-divider"></div>

                        <div class="collapsible-header" onclick="toggleCollapsible('chat-section')">
                            <div class="collapsible-title">
                                <span class="icon">ðŸ’¬</span>
                                <span>Chat general</span>
                            </div>
                            <span class="collapsible-icon">â–¼</span>
                        </div>
                        <div class="collapsible-content open" id="chat-section">
                            <div class="collapsible-content-inner">
                                <div class="player-list" id="chat-list"></div>
                                <div class="btn-row" style="margin-top:12px;">
                                    <input type="text" id="chat-input" placeholder="Mensaje para todos..." style="flex:1;margin-bottom:0;">
                                    <button class="btn btn-secondary" id="send-chat-btn" type="button">Enviar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
</div>

<!-- MÃºsica (pon un archivo bg-music.mp3 en la misma carpeta) -->
<audio id="bg-music" src="bg-music.mp3" loop></audio>

<script>
    // CONFIG FIREBASE TU PROYECTO
    const firebaseConfig = {
        apiKey: "AIzaSyB9kCMt-SUaQFWMFweFnWHDo5_MfH-",
        authDomain: "juego-del-impostor-online.firebaseapp.com",
        databaseURL: "https://juego-del-impostor-online-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "juego-del-impostor-online",
        storageBucket: "juego-del-impostor-online.appspot.com",
        messagingSenderId: "313609877232",
        appId: "1:313609877232:web:f5481d9152019dfa2389",
        measurementId: "G-7GCQ00PFQ6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // PALABRAS (pistas menos obvias)
    const RANDOM_WORDS = [
        {word:"LasaÃ±a",hint:"Capas"},
        {word:"Mandarina",hint:"Invierno"},
        {word:"Helado",hint:"FrÃ­o"},
        {word:"Croqueta",hint:"Ansia"},
        {word:"Sopa",hint:"Calidez"},
        {word:"Biblioteca",hint:"Silencio"},
        {word:"EstaciÃ³n",hint:"Espera"},
        {word:"Faro",hint:"GuÃ­a"},
        {word:"JardÃ­n",hint:"Crecimiento"},
        {word:"Mercado",hint:"AgitaciÃ³n"},
        {word:"Tren",hint:"Trayecto"},
        {word:"Metro",hint:"Profundidad"},
        {word:"Barco",hint:"Horizonte"},
        {word:"Bicicleta",hint:"Equilibrio"},
        {word:"Taxi",hint:"Destino"},
        {word:"Ajedrez",hint:"Estrategia"},
        {word:"Correr",hint:"Impulso"},
        {word:"Pintar",hint:"Trazos"},
        {word:"Cocinar",hint:"TransformaciÃ³n"},
        {word:"Leer",hint:"ImaginaciÃ³n"},
        {word:"Linterna",hint:"BÃºsqueda"},
        {word:"Llave",hint:"Acceso"},
        {word:"Mochila",hint:"Carga"},
        {word:"Reloj",hint:"Ritmo"},
        {word:"Espejo",hint:"Reflejo"},
        {word:"RÃ­o",hint:"Fluir"},
        {word:"Nube",hint:"Cambio"},
        {word:"Bosque",hint:"Ecos"},
        {word:"Desierto",hint:"VacÃ­o"},
        {word:"Cascada",hint:"Impetu"},
        {word:"Ventana",hint:"Perspectiva"},
        {word:"Libro",hint:"Ideas"},
        {word:"Sombrero",hint:"Identidad"},
        {word:"Maleta",hint:"Partida"},
        {word:"CafÃ©",hint:"Alerta"},
        {word:"Pared",hint:"LÃ­mite"},
        {word:"Silla",hint:"Pausa"},
        {word:"Vaso",hint:"Mitad"},
        {word:"Puente",hint:"UniÃ³n"},
        {word:"Niebla",hint:"Duda"},
        {word:"Tormenta",hint:"TensiÃ³n"},
        {word:"Lago",hint:"Calma"},
        {word:"Arena",hint:"Persistencia"},
        {word:"VolcÃ¡n",hint:"Fondo"},
        {word:"Museo",hint:"Memoria"},
        {word:"Teatro",hint:"FicciÃ³n"},
        {word:"Parque",hint:"Respiro"},
        {word:"Hotel",hint:"TrÃ¡nsito"},
        {word:"Plaza",hint:"Cruce"},
        {word:"Chocolate",hint:"TentaciÃ³n"},
        {word:"Pan",hint:"Costumbre"},
        {word:"Fresa",hint:"Dulzura"},
        {word:"Aceituna",hint:"CarÃ¡cter"},
        {word:"Queso",hint:"Madurez"},
        {word:"CÃ¡mara",hint:"Instante"},
        {word:"Cuaderno",hint:"AnotaciÃ³n"},
        {word:"TelÃ©fono",hint:"ConexiÃ³n"},
        {word:"Cantar",hint:"Voz"},
        {word:"Dibujar",hint:"Forma"},
        {word:"Coser",hint:"UniÃ³n"},
        {word:"Bailar",hint:"Ritmo"},
        {word:"MontaÃ±a",hint:"Altura"},
        {word:"Isla",hint:"Aislamiento"},
        {word:"Selva",hint:"Caos"},
        {word:"Cueva",hint:"Eco"},
        {word:"Carpeta",hint:"Orden"},
        {word:"Teclado",hint:"Golpes"},
        {word:"RatÃ³n",hint:"PrecisiÃ³n"},
        {word:"Pantalla",hint:"Brillo"},
        {word:"Cable",hint:"ConexiÃ³n"},
        {word:"Puerta",hint:"Entrada"},
        {word:"Escalera",hint:"Altura"},
        {word:"Cortina",hint:"Oculto"},
        {word:"Alfombra",hint:"Paso"},
        {word:"Lampara",hint:"Claridad"},
        {word:"Perro",hint:"Lealtad"},
        {word:"Gato",hint:"Independencia"},
        {word:"Tortuga",hint:"Constancia"},
        {word:"Caballo",hint:"Impulso"},
        {word:"PÃ¡jaro",hint:"Ligereza"},
        {word:"Estrella",hint:"Distancia"},
        {word:"Luna",hint:"Ciclo"},
        {word:"Sol",hint:"Centro"},
        {word:"Cometa",hint:"Fugacidad"},
        {word:"Planeta",hint:"Ã“rbita"},
        {word:"Camisa",hint:"Prenda"},
        {word:"PantalÃ³n",hint:"Vestir"},
        {word:"CalcetÃ­n",hint:"Par"},
        {word:"Chaqueta",hint:"Abrigo"},
        {word:"Zapato",hint:"Paso"},
        {word:"Gafas",hint:"Enfoque"},
        {word:"Rueda",hint:"RotaciÃ³n"},
        {word:"Martillo",hint:"Golpe"},
        {word:"Tijeras",hint:"Corte"},
        {word:"Regla",hint:"Medida"},
        {word:"Caramelo",hint:"Infancia"},
        {word:"Empanada",hint:"Relleno"},
        {word:"TÃ©",hint:"Reposo"},
        {word:"SandÃ­a",hint:"Frescura"},
        {word:"Nuez",hint:"CÃ¡scara"},
        {word:"Pradera",hint:"Apertura"},
        {word:"Glaciar",hint:"Antiguo"},
        {word:"Trueno",hint:"Impacto"},
        {word:"Arcoiris",hint:"TransiciÃ³n"},
        {word:"Estadio",hint:"Multitud"},
        {word:"Catedral",hint:"Eternidad"},
        {word:"Cementerio",hint:"Silencio"},
        {word:"Puerto",hint:"Llegadas"},
        {word:"BaterÃ­a",hint:"EnergÃ­a"},
        {word:"BolÃ­grafo",hint:"Tinta"},
        {word:"Moneda",hint:"Intercambio"},
        {word:"Puzzle",hint:"Encaje"},
        {word:"DominÃ³",hint:"CaÃ­da"},
        {word:"Dados",hint:"Azar"},
        {word:"Naipes",hint:"Jugada"},
        {word:"BrÃºjula",hint:"OrientaciÃ³n"},
        {word:"Candado",hint:"Cierre"},
        {word:"JarrÃ³n",hint:"Fragilidad"},
        {word:"HelicÃ³ptero",hint:"Altitud"},
        {word:"Anillo",hint:"CÃ­rculo"},
        {word:"Sombra",hint:"Seguimiento"},
        {word:"Trenza",hint:"Enlace"},
        {word:"Esponja",hint:"AbsorciÃ³n"},
        {word:"Rosa",hint:"Aroma"},
        {word:"Corbata",hint:"Formalidad"},
        {word:"BuzÃ³n",hint:"Mensajes"},
        {word:"Termo",hint:"RetenciÃ³n"},
        {word:"Pizarra",hint:"Tiza"},
        {word:"Velero",hint:"Viento"},
        {word:"Carpintero",hint:"Madera"},
        {word:"HeladerÃ­a",hint:"Dulzura"},
        {word:"Pilar",hint:"Soporte"},
        {word:"Estuche",hint:"Guardado"},
        {word:"Agenda",hint:"Horario"},
        {word:"Ventilador",hint:"Aire"},
        {word:"SemÃ¡foro",hint:"Orden"},
        {word:"TrampolÃ­n",hint:"Impulso"},
        {word:"Cuerda",hint:"TensiÃ³n"},
        {word:"Brasa",hint:"Calor"},
        {word:"Cartera",hint:"Documentos"},
        {word:"Rana",hint:"Salto"},
        {word:"Guitarra",hint:"Cuerdas"},
        {word:"Tambor",hint:"Golpeo"},
        {word:"Pincel",hint:"Detalle"},
        {word:"Caracol",hint:"Lentitud"},
        {word:"Acera",hint:"Camino"},
        {word:"Agua",hint:"Fluido"},
        {word:"Aguja",hint:"PrecisiÃ³n"},
        {word:"Aire",hint:"Ligereza"},
        {word:"Alarma",hint:"Aviso"},
        {word:"Almohada",hint:"SueÃ±o"},
        {word:"Alquiler",hint:"Temporal"},
        {word:"Arena",hint:"Grano"},
        {word:"Asiento",hint:"Reposo"},
        {word:"Azulejo",hint:"Mosaico"},
        {word:"Balanza",hint:"Equilibrio"},
        {word:"Barra",hint:"Apoyo"},
        {word:"Bebida",hint:"Refresco"},
        {word:"Bicicleta",hint:"Pedaleo"},
        {word:"Billete",hint:"Viaje"},
        {word:"Botella",hint:"Contenido"},
        {word:"Caja",hint:"Contenedor"},
        {word:"Calor",hint:"Fuego"},
        {word:"Calle",hint:"TrÃ¡nsito"},
        {word:"Cama",hint:"Descanso"},
        {word:"Camino",hint:"Recorrido"},
        {word:"Cangrejo",hint:"Costas"},
        {word:"Canoa",hint:"RÃ­o"},
        {word:"Capucha",hint:"ProtecciÃ³n"},
        {word:"Carretera",hint:"Asfalto"},
        {word:"Carta",hint:"Mensaje"},
        {word:"Casco",hint:"Cabeza"},
        {word:"Cesta",hint:"Recoger"},
        {word:"ChampÃº",hint:"Limpieza"},
        {word:"Charco",hint:"Reflejo"},
        {word:"Cierre",hint:"Seguridad"},
        {word:"Cinta",hint:"Lazo"},
        {word:"Circulo",hint:"Forma"},
        {word:"Clavo",hint:"FijaciÃ³n"},
        {word:"Clave",hint:"Secreto"},
        {word:"Coche",hint:"Ruedas"},
        {word:"Collar",hint:"Adorno"},
        {word:"Comida",hint:"Alimento"},
        {word:"Concha",hint:"Costas"},
        {word:"Cuadro",hint:"Arte"},
        {word:"Cuerno",hint:"Animal"},
        {word:"Dado",hint:"Azar"},
        {word:"Diente",hint:"Morder"},
        {word:"Diamante",hint:"Brillo"},
        {word:"Documento",hint:"Prueba"},
        {word:"Escalera",hint:"Subida"},
        {word:"Espejo",hint:"Reflejo"},
        {word:"Estrella",hint:"Cielo"},
        {word:"Faro",hint:"SeÃ±al"},
        {word:"Flecha",hint:"DirecciÃ³n"},
        {word:"Flor",hint:"Fragancia"},
        {word:"Fruta",hint:"Dulce"},
        {word:"Gafas",hint:"VisiÃ³n"},
        {word:"Gallo",hint:"Amanecer"},
        {word:"Gato",hint:"Sigilo"},
        {word:"Globo",hint:"Inflar"},
        {word:"Gol",hint:"Meta"},
        {word:"Gorra",hint:"Cabeza"},
        {word:"Guante",hint:"Mano"},
        {word:"Helado",hint:"FrÃ­o"},
        {word:"Hielo",hint:"Congelado"},
        {word:"Hoja",hint:"Arbol"},
        {word:"Hueco",hint:"Vacio"},
        {word:"Huevo",hint:"CÃ¡scara"},
        {word:"Isla",hint:"Aislamiento"},
        {word:"JabÃ³n",hint:"Limpieza"},
        {word:"JarrÃ³n",hint:"Fragilidad"},
        {word:"Juguete",hint:"DiversiÃ³n"},
        {word:"Llave",hint:"Acceso"},
        {word:"Luz",hint:"Brillo"},
        {word:"Manzana",hint:"Fruta"},
        {word:"Mapa",hint:"UbicaciÃ³n"},
        {word:"Mar",hint:"Olas"},
        {word:"Martillo",hint:"Golpe"},
        {word:"Mesa",hint:"Superficie"},
        {word:"Mono",hint:"Ãgil"},
        {word:"MontaÃ±a",hint:"Altura"},
        {word:"Mochila",hint:"Carga"},
        {word:"Mosquito",hint:"Picadura"},
        {word:"Nube",hint:"Cambio"},
        {word:"Ojo",hint:"Vista"},
        {word:"Palabra",hint:"Voz"},
        {word:"Paleta",hint:"Color"},
        {word:"Pan",hint:"Horno"},
        {word:"Papel",hint:"Escribir"},
        {word:"Paraguas",hint:"Lluvia"},
        {word:"Parque",hint:"Respiro"},
        {word:"Pelota",hint:"Rebote"},
        {word:"Perro",hint:"Lealtad"},
        {word:"Piedra",hint:"Peso"},
        {word:"Pincel",hint:"Detalle"},
        {word:"Playa",hint:"Arena"},
        {word:"Pluma",hint:"Escribir"},
        {word:"Puerta",hint:"Entrada"},
        {word:"Rana",hint:"Salto"},
        {word:"Reloj",hint:"Tiempo"},
        {word:"RÃ­o",hint:"Fluir"},
        {word:"Rueda",hint:"RotaciÃ³n"},
        {word:"Silla",hint:"Reposo"},
        {word:"Sol",hint:"Luz"},
        {word:"Sombrero",hint:"Cabeza"},
        {word:"Taza",hint:"Bebida"},
        {word:"TelÃ©fono",hint:"ConexiÃ³n"},
        {word:"Tijeras",hint:"Corte"},
        {word:"Tren",hint:"Viaje"},
        {word:"Ventana",hint:"Perspectiva"},
        {word:"Viento",hint:"Movimiento"},
        {word:"Zapato",hint:"Paso"},
        {word:"Zorro",hint:"Astucia"}
   
    ];

    // DOM
    const nicknameInput = document.getElementById('nickname');
    const roomCodeJoinInput = document.getElementById('room-code-join');
    const createRoomBtn = document.getElementById('create-room-btn');
    const joinRoomBtn = document.getElementById('join-room-btn');
    const enableBotsCheckbox = document.getElementById('enable-bots-checkbox');
    const botCountInputContainer = document.getElementById('bot-count-input-container');
    const botCountInput = document.getElementById('bot-count-input');

    const hostSettings = document.getElementById('host-settings');
    const expectedPlayersInput = document.getElementById('expected-players');
    const secretWordInput = document.getElementById('secret-word');
    const hintInput = document.getElementById('hint');
    const randomWordBtn = document.getElementById('random-word-btn');
    const giveHintCheckbox = document.getElementById('give-hint-checkbox');
    const timerEnabledCheckbox = document.getElementById('timer-enabled-checkbox');
    const clueTimerInput = document.getElementById('clue-timer-input');
    const voteTimerInput = document.getElementById('vote-timer-input');
    const startGameBtn = document.getElementById('start-game-btn');
    const startVoteBtn = document.getElementById('start-vote-btn');
    const hostStatusText = document.getElementById('host-status-text');

    const roomStatusSmall = document.getElementById('room-status-small');
    const roomInfo = document.getElementById('room-info');
    const roomCodeDisplay = document.getElementById('room-code-display');
    const copyCodeBtn = document.getElementById('copy-code-btn');
    const leaveRoomBtn = document.getElementById('leave-room-btn');
    const playersListDiv = document.getElementById('players-list');
    const roomPhaseChip = document.getElementById('room-phase-chip');
    const roleCard = document.getElementById('role-card');
    const roleMainText = document.getElementById('role-main-text');
    const roleExtraText = document.getElementById('role-extra-text');

    const gamePhasePanel = document.getElementById('game-phase-panel');
    const phaseSummary = document.getElementById('phase-summary');
    const phaseTimer = document.getElementById('phase-timer');
    const timerDisplay = document.getElementById('timer-display');
    const cluesListDiv = document.getElementById('clues-list');
    const clueInputRow = document.getElementById('clue-input-row');
    const clueInput = document.getElementById('clue-input');
    const sendClueBtn = document.getElementById('send-clue-btn');
    const clueHintText = document.getElementById('clue-hint-text');

    const voteSection = document.getElementById('vote-section');
    const voteCardsDiv = document.getElementById('vote-cards');
    const sendVoteBtn = document.getElementById('send-vote-btn');
    const voteHintText = document.getElementById('vote-hint-text');

    const chatListDiv = document.getElementById('chat-list');
    const chatInput = document.getElementById('chat-input');
    const sendChatBtn = document.getElementById('send-chat-btn');

    const musicAudio = document.getElementById('bg-music');
    const musicToggleBtn = document.getElementById('music-toggle-btn');
    const musicVolumeControl = document.getElementById('music-volume-control');
    const musicVolumeSlider = document.getElementById('music-volume-slider');
    const soundsToggleBtn = document.getElementById('sounds-toggle-btn');
    const themeToggle = document.getElementById('theme-toggle');
    const votePromptModal = document.getElementById('vote-prompt-modal');
    const votePromptTimer = document.getElementById('vote-prompt-timer');
    const votePromptYes = document.getElementById('vote-prompt-yes');
    const votePromptNo = document.getElementById('vote-prompt-no');
    const gameResultModal = document.getElementById('game-result-modal');
    const gameResultIcon = document.getElementById('game-result-icon');
    const gameResultTitle = document.getElementById('game-result-title');
    const gameResultSubtitle = document.getElementById('game-result-subtitle');
    const newGameBtn = document.getElementById('new-game-btn');
    const exitGameBtn = document.getElementById('exit-game-btn');
    const spectatorSection = document.getElementById('spectator-section');
    const spectatorWord = document.getElementById('spectator-word');
    const toastContainer = document.getElementById('toast-container');
    const connectionIndicator = document.getElementById('connection-indicator');
    const connectionDot = document.getElementById('connection-dot');
    const connectionText = document.getElementById('connection-text');
    const playerCountBadge = document.getElementById('player-count-badge');
    const playerCountNumber = document.getElementById('player-count-number');
    const modeSelectionModal = document.getElementById('mode-selection-modal');
    const modeCards = document.querySelectorAll('.mode-card');
    const confirmModeBtn = document.getElementById('confirm-mode-btn');

    // Estado local
    let currentRoomCode = null;
    let currentPlayerId = null;
    let isHost = false;
    let roomListener = null;
    let selectedVoteTarget = null;
    let musicOn = false;
    let lastPlayerCount = 0;
    let connectionState = true;
    let selectedMode = null;
    let currentSecretWord = null; // Para detectar palabra secreta en pistas
    let votePromptInterval = null; // Timer para votaciÃ³n intermitente
    let botsEnabled = false; // Modo con bots
    let lastShownWinner = null; // Para evitar mostrar el modal mÃºltiples veces
    let lastShownEjectedId = null; // Para evitar mostrar el mensaje de expulsiÃ³n mÃºltiples veces
    let phaseTimerInterval = null; // Intervalo del temporizador
    let notificationPermission = null; // Permiso para notificaciones
    
    // Tema
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    themeToggle.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
    
    themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        themeToggle.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
        localStorage.setItem('theme', newTheme);
        showToast('success', 'Tema cambiado', 'Has cambiado a modo ' + (newTheme === 'dark' ? 'oscuro' : 'claro'));
    });

    // Toast Notification System
    function showToast(type, title, message) {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        const icons = {
            success: 'âœ…',
            error: 'âŒ',
            info: 'â„¹ï¸',
            warning: 'âš ï¸'
        };
        toast.innerHTML = `
            <span class="toast-icon">${icons[type] || icons.info}</span>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            </div>
        `;
        toast.addEventListener('click', () => {
            toast.style.animation = 'fadeOut 0.3s ease forwards';
            setTimeout(() => toast.remove(), 300);
        });
        toastContainer.appendChild(toast);
        setTimeout(() => {
            if (toast.parentNode) {
                toast.style.animation = 'fadeOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }
        }, 3000);
        playSound(type);
    }

    // Sound System mejorado (Web Audio API)
    let audioContext = null;
    let soundsEnabled = localStorage.getItem('soundsEnabled') !== 'false';
    
    function initAudioContext() {
        if (!audioContext) {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.warn('Audio context no disponible');
            }
        }
        return audioContext;
    }
    
    function playSound(type, volume = 0.15) {
        if (!soundsEnabled) return;
        try {
            const ctx = initAudioContext();
            if (!ctx) return;
            
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            gainNode.gain.setValueAtTime(0, ctx.currentTime);
            gainNode.gain.linearRampToValueAtTime(volume, ctx.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
            
            const sounds = {
                success: { freq: 523.25, duration: 0.15 }, // C5
                error: { freq: 220, duration: 0.2 },       // A3
                info: { freq: 440, duration: 0.1 },         // A4
                warning: { freq: 330, duration: 0.15 },    // E4
                vote: { freq: 659.25, duration: 0.1 },      // E5
                clue: { freq: 392, duration: 0.1 },         // G4
                eject: { freq: 147, duration: 0.3 },       // D3
                victory: { freq: 880, duration: 0.2 }       // A5
            };
            
            const sound = sounds[type] || sounds.info;
            oscillator.frequency.value = sound.freq;
            oscillator.type = type === 'eject' ? 'sawtooth' : 'sine';
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + sound.duration);
        } catch (e) {
            // Silently fail
        }
    }
    
    // EstadÃ­sticas del jugador
    let playerStats = JSON.parse(localStorage.getItem('impostorStats') || '{"games":0,"wins":0,"losses":0,"asImpostor":0,"winsAsImpostor":0}');
    
    function updateStats(wasImpostor, won) {
        playerStats.games++;
        if (won) {
            playerStats.wins++;
            if (wasImpostor) {
                playerStats.asImpostor++;
                playerStats.winsAsImpostor++;
            }
        } else {
            playerStats.losses++;
            if (wasImpostor) {
                playerStats.asImpostor++;
            }
        }
        localStorage.setItem('impostorStats', JSON.stringify(playerStats));
    }
    
    function getStats() {
        return playerStats;
    }
    
    function syncPhaseTimerFromData(data){
        if(!phaseTimer || !timerDisplay){
            return;
        }
        if(phaseTimerInterval){
            clearInterval(phaseTimerInterval);
            phaseTimerInterval=null;
        }
        const timedPhase = data.phase==="clues" || data.phase==="voting";
        if(data.timerEnabled===false || !data.phaseTimerEndsAt || !timedPhase){
            phaseTimer.style.display="none";
            return;
        }
        phaseTimer.style.display="flex";
        const target=Number(data.phaseTimerEndsAt);
        const update=()=>{
            const remaining=Math.max(0,Math.floor((target-Date.now())/1000));
            const mins=Math.floor(remaining/60);
            const secs=remaining%60;
            timerDisplay.textContent=`${mins}:${secs.toString().padStart(2,'0')}`;
            if(remaining<=0){
                clearInterval(phaseTimerInterval);
                phaseTimerInterval=null;
            }
        };
        update();
        phaseTimerInterval=setInterval(update,1000);
    }
    
    // Sistema de notificaciones del navegador
    async function requestNotificationPermission() {
        if (!("Notification" in window)) return false;
        if (Notification.permission === "granted") return true;
        if (Notification.permission !== "denied") {
            notificationPermission = await Notification.requestPermission();
            return notificationPermission === "granted";
        }
        return false;
    }
    
    function showNotification(title, body, icon = "ðŸ•µï¸â€â™‚ï¸") {
        if (Notification.permission === "granted") {
            new Notification(title, { body, icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><text y='.9em' font-size='90'>" + icon + "</text></svg>" });
        }
    }
    
    // Solicitar permiso al cargar (solo una vez)
    if("Notification" in window && Notification.permission === "default"){
        // Solicitar permiso despuÃ©s de un pequeÃ±o delay para mejor UX
        setTimeout(() => {
            requestNotificationPermission();
        }, 2000);
    }
    
    // Atajos de teclado para accesibilidad
    document.addEventListener("keydown", (e) => {
        // Enter para enviar pista o voto
        if(e.key === "Enter" && !e.shiftKey){
            if(clueInput && document.activeElement === clueInput && sendClueBtn && !sendClueBtn.disabled){
                sendClueBtn.click();
                e.preventDefault();
            }
            if(chatInput && document.activeElement === chatInput && sendChatBtn){
                sendChatBtn.click();
                e.preventDefault();
            }
            if(sendVoteBtn && !sendVoteBtn.disabled && selectedVoteTarget){
                sendVoteBtn.click();
                e.preventDefault();
            }
        }
        // Escape para cerrar modales
        if(e.key === "Escape"){
            if(gameResultModal && gameResultModal.style.display !== "none" && !isHost){
                gameResultModal.style.display = "none";
            }
            if(votePromptModal && votePromptModal.style.display !== "none"){
                // No cerrar, solo informar
            }
        }
    });
    
    // OptimizaciÃ³n: Debounce para actualizaciones frecuentes
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Mejorar rendimiento en mÃ³viles
    if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){
        // Reducir animaciones en mÃ³viles para mejor rendimiento
        document.documentElement.style.setProperty('--animation-duration', '0.2s');
    }
    
    // Efectos visuales de expulsiÃ³n
    function createEjectionEffect(playerName, wasImpostor) {
        const effect = document.createElement("div");
        effect.style.cssText = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:6000;pointer-events:none;";
        effect.innerHTML = `
            <div style="background:${wasImpostor ? 'var(--accent)' : 'var(--danger)'};color:white;padding:20px 30px;border-radius:16px;font-size:18px;font-weight:700;box-shadow:0 8px 32px rgba(0,0,0,0.3);text-align:center;animation:scaleIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;">
                <div style="font-size:32px;margin-bottom:8px;">${wasImpostor ? 'ðŸŽ‰' : 'âŒ'}</div>
                <div>${playerName} expulsado</div>
                <div style="font-size:14px;margin-top:4px;opacity:0.9;">${wasImpostor ? 'Â¡Era el impostor!' : 'No era el impostor'}</div>
            </div>
        `;
        document.body.appendChild(effect);
        setTimeout(() => effect.remove(), 3000);
    }
    
    // AÃ±adir animaciÃ³n de partÃ­culas para victoria
    function createVictoryParticles() {
        for(let i = 0; i < 30; i++){
            setTimeout(() => {
                const particle = document.createElement("div");
                const x = Math.random() * 200 - 100;
                const y = Math.random() * 200 - 100;
                particle.style.cssText = `
                    position:fixed;
                    width:8px;
                    height:8px;
                    background:var(--accent);
                    border-radius:50%;
                    pointer-events:none;
                    z-index:6000;
                    left:${Math.random() * 100}vw;
                    top:${Math.random() * 100}vh;
                    --particle-x:${x}px;
                    --particle-y:${y}px;
                    animation:particleFloat 2s ease-out forwards;
                `;
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 2000);
            }, i * 50);
        }
    }

    // Connection Monitor
    function updateConnectionStatus(connected) {
        if (connected === connectionState) return;
        connectionState = connected;
        if (connected) {
            connectionDot.classList.remove('disconnected');
            connectionText.textContent = 'Conectado';
            connectionIndicator.style.borderColor = 'var(--accent)';
        } else {
            connectionDot.classList.add('disconnected');
            connectionText.textContent = 'Desconectado';
            connectionIndicator.style.borderColor = 'var(--danger)';
            // Mensaje de reconexiÃ³n eliminado para evitar molestias
        }
    }

    // Monitor Firebase connection
    const connectedRef = db.ref('.info/connected');
    connectedRef.on('value', (snap) => {
        updateConnectionStatus(snap.val() === true);
    });

    // Collapsible Sections Function
    function toggleCollapsible(id) {
        const content = document.getElementById(id);
        const header = content.previousElementSibling;
        if (content.classList.contains('open')) {
            content.classList.remove('open');
            header.classList.remove('active');
        } else {
            content.classList.add('open');
            header.classList.add('active');
        }
    }
    
    // Make collapsible function global
    window.toggleCollapsible = toggleCollapsible;

    function generateRoomCode(){
        const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
        let code=""; for(let i=0;i<4;i++) code+=chars.charAt(Math.floor(Math.random()*chars.length));
        return code;
    }

    function clampTimerValue(value, fallback){
        const n = parseInt(value, 10);
        if(isNaN(n)) return fallback;
        return Math.min(300, Math.max(10, n));
    }

    function updateTimerInputsState(){
        if(!timerEnabledCheckbox) return;
        const enabled = timerEnabledCheckbox.checked;
        if(clueTimerInput){
            clueTimerInput.disabled = !enabled;
            clueTimerInput.parentElement.style.opacity = enabled ? "1" : "0.6";
        }
        if(voteTimerInput){
            voteTimerInput.disabled = !enabled;
            voteTimerInput.parentElement.style.opacity = enabled ? "1" : "0.6";
        }
        const card = document.getElementById('timer-settings-card');
        if(card){
            if(enabled) card.classList.remove('disabled');
            else card.classList.add('disabled');
        }
    }

    function applyTimerSettingsFromData(data){
        if(!state.isHost) return;
        if(timerEnabledCheckbox){
            timerEnabledCheckbox.checked = data.timerEnabled !== false;
            updateTimerInputsState();
        }
        if(clueTimerInput) clueTimerInput.value = data.clueTimerSeconds || 60;
        if(voteTimerInput) voteTimerInput.value = data.voteTimerSeconds || 45;
    }
    function setHostStatus(t){hostStatusText.textContent=t||"";}
    function setRoomPhaseChip(phase,text){
        roomPhaseChip.className="status-chip";
        if(phase==="waiting") roomPhaseChip.classList.add("status-wait");
        else if(phase==="ready") roomPhaseChip.classList.add("status-ok");
        else if(phase==="error") roomPhaseChip.classList.add("status-error");
        roomPhaseChip.innerHTML='<span class="dot"></span>'+text;
    }
    function escapeHtml(str){
        return String(str).replace(/[&<>"']/g,s=>({
            '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[s]||s));
    }
    
    // FunciÃ³n para convertir nÃºmeros a palitos romanos
    function toRomanNumerals(num){
        if(num<=0) return "";
        // Palitos romanos: I, II, III, IIII, IIIII, etc.
        return "I".repeat(num);
    }

    function renderPlayersList(data){
        const players=data.players||{};
        const bots=data.bots||{};
        const alive=data.alive||{};
        const hostId=data.hostId;
        const hostPlays=(data.hostPlays!==false);
        const ids=Object.keys(players).sort((a,b)=>players[a].joinedAt-players[b].joinedAt);
        const playingIds=hostPlays?ids:ids.filter(id=>id!==hostId);
        const currentCount=playingIds.length;
        
        // Update player count badge
        if(currentCount>0){
            playerCountBadge.style.display="inline-flex";
            playerCountNumber.textContent=currentCount;
            if(currentCount!==lastPlayerCount && lastPlayerCount>0){
                if(currentCount>lastPlayerCount){
                    showToast('success','Jugador unido','Un nuevo jugador se ha unido a la sala');
                }else{
                    showToast('info','Jugador saliÃ³','Un jugador ha abandonado la sala');
                }
            }
            lastPlayerCount=currentCount;
        }else{
            playerCountBadge.style.display="none";
            lastPlayerCount=0;
        }
        
        playersListDiv.innerHTML="";
        ids.forEach(id=>{
            const p=players[id];
            const div=document.createElement("div");
            div.className="player-item";
            const left=document.createElement("div");
            left.style.display="flex";left.style.alignItems="center";
            const dot=document.createElement("span");
            dot.className="player-dot";
            if(alive[id]===false) dot.style.background="#9b1c1c";
            left.appendChild(dot);
            const nameSpan=document.createElement("span");
            nameSpan.className="name";
            nameSpan.textContent=p.name||"Jugador";
            // Solo verde si es host Y no juega (espectador)
            if(id===hostId && !hostPlays){
                nameSpan.style.color="#16a34a";
            }else{
                nameSpan.style.color="";
            }
            left.appendChild(nameSpan);
            if(id===currentPlayerId){
                const me=document.createElement("span");
                me.className="me";me.textContent="TÃº";
                left.appendChild(me);
            }
            div.appendChild(left);

            const right=document.createElement("div");
            right.style.fontSize="11px";
            right.style.color="var(--text-muted)";
            if(bots[id]){
                const chip=document.createElement("span");
                chip.className="chip-small";
                chip.style.background="rgba(139,92,246,0.2)";
                chip.style.color="#6d28d9";
                chip.textContent="ðŸ¤– BOT";
                right.appendChild(chip);
            }
            if(id===hostId){
                const chip=document.createElement("span");
                chip.className="chip-small chip-host";
                chip.textContent=hostPlays?"HOST":"HOST (espectador)";
                right.appendChild(chip);
            }
            if(alive[id]===false){
                const chip=document.createElement("span");
                chip.className="chip-small chip-dead";
                chip.textContent="EXPULSADO";
                right.appendChild(chip);
            }
            // BotÃ³n de expulsar (solo para host, no para sÃ­ mismo, no para host espectador)
            if(isHost && id!==currentPlayerId && id!==hostId && alive[id]!==false){
                const kickBtn=document.createElement("button");
                kickBtn.className="btn btn-danger";
                kickBtn.style.padding="4px 12px";
                kickBtn.style.fontSize="11px";
                kickBtn.style.marginLeft="8px";
                kickBtn.textContent=data.phase==="lobby" && !data.rolesAssigned ? "Expulsar" : "Kick";
                kickBtn.title="Expulsar jugador";
                kickBtn.addEventListener("click",async(e)=>{
                    e.stopPropagation();
                    if(confirm("Â¿EstÃ¡s seguro de que quieres expulsar a "+escapeHtml(p.name||"Jugador")+"?")){
                        await kickPlayerFromRoom(currentRoomCode,id,data);
                    }
                });
                right.appendChild(kickBtn);
            }
            div.appendChild(right);
            playersListDiv.appendChild(div);
        });
    }

    function showMyRole(data){
        const players=data.players||{};
        const alive=data.alive||{};
        const hostId=data.hostId;
        const hostPlays=(data.hostPlays!==false);
        const isHostSpectator=(currentPlayerId===hostId && !hostPlays);
        
        const roleHeader = document.getElementById('role-header');
        const roleSection = document.getElementById('role-section');
        
        // Si es espectador host, mostrar secciÃ³n de espectador
        if(isHostSpectator && data.rolesAssigned && data.secretWord){
            if(roleHeader) roleHeader.style.display="flex";
            if(roleSection) roleSection.style.display="block";
            spectatorSection.style.display="block";
            roleCard.style.display="none";
            spectatorWord.textContent=escapeHtml(data.secretWord||"");
            return;
        }
        
        spectatorSection.style.display="none";
        
        if(!data.rolesAssigned || !players[currentPlayerId] || alive[currentPlayerId]===false){
            roleCard.style.display="none";
            if(roleHeader) roleHeader.style.display="none";
            if(roleSection) roleSection.style.display="none";
            return;
        }
        
        if(roleHeader) roleHeader.style.display="flex";
        if(roleSection) roleSection.style.display="block";
        
        const impostorId=data.impostorId;
        const isImpostor=(currentPlayerId===impostorId);
        roleCard.style.display="block";
        const hintEnabled=(data.hintEnabled!==false);

        if(isImpostor){
            roleMainText.textContent="Eres el IMPOSTOR ðŸ•µï¸â€â™‚ï¸";
            roleMainText.className="role-main role-impostor";
            if(hintEnabled && data.hint){
                roleExtraText.innerHTML="<strong>Pista que recibes:</strong> "+escapeHtml(data.hint)+
                    "<br><br>Intenta sonar convincente sin copiar demasiado.";
            }else{
                roleExtraText.textContent="No tienes pista. Copia un poco el estilo de los demÃ¡s para no levantar sospechas.";
            }
        }else{
            roleMainText.textContent="NO eres el impostor âœ…";
            roleMainText.className="role-main role-normal";
            roleExtraText.innerHTML=
                "<div class='role-label' style='margin-top:8px;'>Palabra secreta</div>"+
                "<div class='secret-word'>"+escapeHtml(data.secretWord||"")+"</div>"+
                "<div style='margin-top:8px;font-size:12px;color:var(--text-muted)'>Da una pista no muy obvia para intentar pillar al impostor.</div>";
        }
    }

    function renderCluesAndVotes(data){
        const players=data.players||{};
        const alive=data.alive||{};
        const clues=data.clues||{};
        const votes=data.votes||{};
        const ids=Object.keys(players).sort((a,b)=>players[a].joinedAt-players[b].joinedAt);
        const aliveIds=ids.filter(id=>alive[id]!==false);
        const myAlive=alive[currentPlayerId]!==false;
        const phase=data.phase||"lobby";
        const round=data.round||1;

        if(!data.rolesAssigned){
            gamePhasePanel.style.display="none";
            // Hide role section if game not started
            const roleHeader = document.getElementById('role-header');
            const roleSection = document.getElementById('role-section');
            if(roleHeader) roleHeader.style.display="none";
            if(roleSection) roleSection.style.display="none";
            return;
        }
        gamePhasePanel.style.display="block";
        
        // Guardar palabra secreta para validaciÃ³n
        currentSecretWord = data.secretWord || null;

        let phaseText="";
        if(phase==="clues") phaseText="Ronda "+round+": fase de pistas. Cada jugador activo escribe una pista.";
        else if(phase==="voting") phaseText="Ronda "+round+": fase de votaciÃ³n. Elegid a quiÃ©n expulsar.";
        else if(phase==="ended"){
            if(data.winner==="players") phaseText="Partida terminada: Â¡habÃ©is expulsado al impostor! ðŸŽ‰";
            else if(data.winner==="impostor") phaseText="Partida terminada: el impostor ha ganado. ðŸ˜ˆ";
            else phaseText="Partida terminada.";
        }else phaseText="Esperando a que empiece la partidaâ€¦";
        phaseSummary.textContent=phaseText;
        
        syncPhaseTimerFromData(data);

        // Pistas
        cluesListDiv.innerHTML="";
        aliveIds.forEach(id=>{
            const clueData=clues[id];
            const div=document.createElement("div");
            div.className="game-clue-item";
            const nameDiv=document.createElement("div");
            const nameSpan=document.createElement("span");
            nameSpan.className="clue-item-name";
            nameSpan.textContent=(players[id]?.name||"Jugador")+":";
            nameDiv.appendChild(nameSpan);
            const textSpan=document.createElement("span");
            textSpan.className="clue-item-text";
            textSpan.textContent=clueData?" "+clueData.text:" (sin pista)";
            nameDiv.appendChild(textSpan);
            div.appendChild(nameDiv);

            const right=document.createElement("div");
            if(clueData){
                const chip=document.createElement("span");
                chip.className="chip-small";
                chip.style.background="var(--accent-soft)";
                chip.style.color="#166534";
                chip.textContent="OK";
                right.appendChild(chip);
            }
            div.appendChild(right);
            cluesListDiv.appendChild(div);
        });

        const myClue=clues[currentPlayerId];
        const myVote=votes[currentPlayerId];

        // Input de pistas
        if(phase==="clues" && myAlive && !myClue && data.winner==null){
            clueInputRow.style.display="flex";
            clueHintText.textContent="Solo una pista por ronda. Cuando todos escriban, el host pasarÃ¡ a votaciÃ³n.";
            // Validar en tiempo real si contiene la palabra secreta
            clueInput.addEventListener("input",checkClueForSecretWord);
            checkClueForSecretWord(); // Verificar al mostrar
        }else{
            clueInput.removeEventListener("input",checkClueForSecretWord);
            clueInput.classList.remove("clue-contains-secret-word");
            clueInputRow.style.display="none";
            if(!myAlive) clueHintText.textContent="EstÃ¡s expulsado. Puedes seguir viendo la partida.";
            else if(phase==="voting") clueHintText.textContent="Ya estÃ¡is en votaciÃ³n.";
            else if(phase==="ended") clueHintText.textContent="La partida ha terminado.";
            else if(myClue) clueHintText.textContent="Ya has enviado tu pista. Espera al resto.";
            else clueHintText.textContent="";
        }

        // VotaciÃ³n
        voteCardsDiv.innerHTML="";
        selectedVoteTarget=null;
        const voteHeader = document.getElementById('vote-header');
        const hostId = data.hostId;
        const hostPlays = (data.hostPlays !== false);
        
        // Contar votos en tiempo real (solo de jugadores vivos)
        const voteCounts={};
        Object.keys(votes).forEach(voterId=>{
            // Solo contar votos de jugadores vivos
            if(alive[voterId] === false) return;
            const targetId=votes[voterId]?.targetId;
            if(targetId){
                voteCounts[targetId]=(voteCounts[targetId]||0)+1;
            }
        });
        
        if(phase==="voting"){
            // Asegurar que la secciÃ³n estÃ© visible
            voteSection.style.display="block";
            const voteSectionElement = document.getElementById('vote-section');
            if(voteSectionElement) voteSectionElement.style.display="block";
            if(voteHeader) voteHeader.style.display="flex";
            
            // Limpiar tarjetas anteriores
            voteCardsDiv.innerHTML="";
            
            const availableTargets = aliveIds.filter(id=>
                id!==currentPlayerId && 
                !(id===hostId && !hostPlays)
            );
            
            if(availableTargets.length === 0){
                voteHintText.textContent="No hay jugadores disponibles para votar.";
                sendVoteBtn.disabled=true;
            }else{
                // Ordenar jugadores por nÃºmero de votos (mayor a menor)
                const sortedTargets = availableTargets.sort((a, b) => {
                    const votesA = voteCounts[a] || 0;
                    const votesB = voteCounts[b] || 0;
                    return votesB - votesA; // Orden descendente
                });
                
                sortedTargets.forEach(id=>{
                    const card=document.createElement("div");
                    card.className="game-vote-card";
                    card.dataset.targetId=id;
                    
                    const left=document.createElement("div");
                    left.style.display="flex";
                    left.style.alignItems="center";
                    left.style.gap="12px";
                    const name=document.createElement("span");
                    name.className="vote-name";
                    name.textContent=players[id]?.name||"Jugador";
                    left.appendChild(name);
                    
                    // Mostrar votos en palitos romanos
                    const voteCount=voteCounts[id]||0;
                    if(voteCount>0){
                        const voteBadge=document.createElement("span");
                        voteBadge.className="vote-count-badge";
                        voteBadge.textContent=toRomanNumerals(voteCount);
                        voteBadge.title=voteCount+" voto"+(voteCount!==1?"s":"");
                        left.appendChild(voteBadge);
                    }
                    
                    card.appendChild(left);
                    const right=document.createElement("div");
                    const chip=document.createElement("span");
                    chip.className="vote-chip";
                    if(selectedVoteTarget===id){
                        chip.textContent="âœ“ Seleccionado";
                        chip.style.color="var(--accent)";
                        chip.style.fontWeight="600";
                    }else{
                        chip.textContent="Clic para votar";
                    }
                    right.appendChild(chip);
                    card.appendChild(right);
                    
                    if(selectedVoteTarget===id){
                        card.classList.add("selected");
                    }
                    
                    card.addEventListener("click",()=>{
                        if(!myAlive || myVote || data.winner!=null) return;
                        selectedVoteTarget=id;
                        Array.from(voteCardsDiv.children).forEach(c=>{
                            c.classList.remove("selected");
                            const chipEl=c.querySelector(".vote-chip");
                            if(chipEl){
                                chipEl.textContent="Clic para votar";
                                chipEl.style.color="";
                                chipEl.style.fontWeight="";
                            }
                        });
                        card.classList.add("selected");
                        const chipEl=card.querySelector(".vote-chip");
                        if(chipEl){
                            chipEl.textContent="âœ“ Seleccionado";
                            chipEl.style.color="var(--accent)";
                            chipEl.style.fontWeight="600";
                        }
                        if(sendVoteBtn) sendVoteBtn.disabled=false;
                    });
                    voteCardsDiv.appendChild(card);
                });

                if(!myAlive || myVote || data.winner!=null){
                    if(sendVoteBtn) sendVoteBtn.disabled=true;
                }else{
                    if(sendVoteBtn) sendVoteBtn.disabled=(selectedVoteTarget===null);
                }

                if(!myAlive) voteHintText.textContent="EstÃ¡s expulsado. Solo observas.";
                else if(myVote) voteHintText.textContent="Ya has votado. Espera a que el resto vote.";
                else voteHintText.textContent="Selecciona a alguien y pulsa 'Confirmar voto'.";
            }
        }else{
            voteSection.style.display="none";
            if(voteHeader) voteHeader.style.display="none";
            voteHintText.textContent="";
            selectedVoteTarget=null;
        }
        
        if(isHost){
            const hostPlays=data.hostPlays!==false;
            const livingCluePlayers=aliveIds.filter(id=>alive[id]!==false && !(id===data.hostId && !hostPlays));
            const missingClues=livingCluePlayers.filter(id=>!(clues[id]));
            const timerEnabled=data.timerEnabled!==false;
            const timerExpired=timerEnabled && data.phaseTimerEndsAt && Date.now()>=Number(data.phaseTimerEndsAt);
            if(data.phase==="clues"){
                if(missingClues.length===0){
                    advanceToVoting(currentRoomCode,data);
                }else if(timerExpired){
                    autoFillMissingClues(currentRoomCode,data,missingClues).then(()=>{
                        advanceToVoting(currentRoomCode,data);
                    });
                }
            }else if(data.phase==="voting" && timerExpired){
                resolveVoting(currentRoomCode,data,ids,aliveIds);
            }
        }
    }

    function renderChat(chatData){
        chatListDiv.innerHTML="";
        if(!chatData) return;
        const msgs=Object.values(chatData).sort((a,b)=>(a.timestamp||0)-(b.timestamp||0));
        msgs.forEach(m=>{
            const div=document.createElement("div");
            div.className="player-item";
            const left=document.createElement("div");
            left.style.display="flex";
            left.style.alignItems="center";
            const dot=document.createElement("span");
            dot.className="player-dot";
            dot.style.background="#3b82f6";
            left.appendChild(dot);
            const nameSpan=document.createElement("span");
            nameSpan.className="name";
            nameSpan.textContent=m.name||"Jugador";
            left.appendChild(nameSpan);
            const textSpan=document.createElement("span");
            textSpan.className="msg-text";
            textSpan.textContent=": "+m.text;
            left.appendChild(textSpan);
            div.appendChild(left);
            chatListDiv.appendChild(div);
        });
    }

    function subscribeRoom(roomCode){
        if(roomListener){roomListener.off();roomListener=null;}
        const ref=db.ref("rooms/"+roomCode);
        roomListener=ref;
        ref.on("value",snap=>{
            const data=snap.val();
            if(!data){
                roomStatusSmall.textContent="La sala no existe o ha sido eliminada.";
                setRoomPhaseChip("error","Sala no encontrada");
                return;
            }
            const players=data.players||{};
            const ids=Object.keys(players).sort((a,b)=>players[a].joinedAt-players[b].joinedAt);
            const alive=data.alive||{};
            const rolesAssigned=!!data.rolesAssigned;

            roomStatusSmall.textContent=isHost
                ?"Eres el anfitriÃ³n. Configura la partida."
                :"Te has unido a la sala. Espera al anfitriÃ³n.";
            
            // Ocultar panel izquierdo cuando la partida empieza
            const mainSettingsCard = document.getElementById('main-settings-card');
            if(mainSettingsCard){
                if(rolesAssigned && data.phase !== "ended"){
                    mainSettingsCard.style.display = "none";
                }else{
                    mainSettingsCard.style.display = "block";
                }
            }
            
            // Ocultar configuraciÃ³n de bots una vez creada la sala
            if(botConfigSection){
                if(currentRoomCode && roomInfo && roomInfo.style.display !== "none"){
                    botConfigSection.style.display = "none";
                }else if(!currentRoomCode){
                    botConfigSection.style.display = "block";
                }
            }
            
            renderPlayersList(data);

            if(!data.secretWord){
                setRoomPhaseChip("waiting","Falta que el anfitriÃ³n ponga palabra.");
            }else if(!rolesAssigned){
                setRoomPhaseChip("waiting","Listo para empezar cuando el anfitriÃ³n quiera.");
            }else if(data.phase==="clues"){
                setRoomPhaseChip("ready","Partida en marcha: fase de pistas.");
            }else if(data.phase==="voting"){
                setRoomPhaseChip("ready","Partida en marcha: votaciÃ³n.");
            }else if(data.phase==="ended"){
                setRoomPhaseChip("ready","Partida terminada.");
            }else{
                setRoomPhaseChip("ready","Partida en marcha.");
            }

            showMyRole(data);
            renderCluesAndVotes(data);
            renderChat(data.chat);
            
            // Mostrar modal de resultado cuando la partida termine
            if(data.phase==="ended" && data.winner){
                // Solo mostrar si no se ha mostrado antes para este winner
                if(lastShownWinner !== data.winner){
                    showGameResultModal(data.winner);
                    lastShownWinner = data.winner;
                }
            }else{
                if(gameResultModal) gameResultModal.style.display="none";
                lastShownWinner = null;
            }
            
            // Procesar acciones de bots
            if(data.botsEnabled){
                processBotActions(roomCode, data);
            }
            
            // Notify phase changes - mostrar expulsiÃ³n solo una vez
            if(data.phase==="voting" && data.lastEjectedId && data.lastEjectedId !== lastShownEjectedId){
                const ejectedPlayer=players[data.lastEjectedId];
                const impostorId = data.impostorId;
                const wasImpostor = data.lastEjectedId === impostorId;
                
                if(ejectedPlayer && data.lastEjectedId!==currentPlayerId){
                    lastShownEjectedId = data.lastEjectedId;
                    playSound(wasImpostor ? 'victory' : 'eject');
                    createEjectionEffect(ejectedPlayer.name, wasImpostor);
                    if(wasImpostor) createVictoryParticles();
                    setTimeout(()=>{
                        if(wasImpostor){
                            showToast('success','Â¡Victoria!',ejectedPlayer.name+' ha sido expulsado. Â¡Era el impostor!');
                            showNotification('Â¡Victoria!', ejectedPlayer.name + ' era el impostor. Â¡Has ganado!', 'ðŸŽ‰');
                        }else{
                            showToast('warning','Jugador expulsado',ejectedPlayer.name+' ha sido expulsado. No era el impostor. La partida continÃºa.');
                        }
                    },1000);
                }
            }
            
            // Notificaciones cuando es tu turno (solo una vez por fase)
            const lastNotifiedPhase = localStorage.getItem('lastNotifiedPhase');
            const currentPhaseKey = `${data.phase}_${currentPlayerId}`;
            if(data.phase === "clues" && !clues[currentPlayerId] && alive[currentPlayerId] !== false && lastNotifiedPhase !== currentPhaseKey){
                showNotification('Tu turno', 'Es hora de dar tu pista', 'ðŸ’¡');
                localStorage.setItem('lastNotifiedPhase', currentPhaseKey);
            }
            if(data.phase === "voting" && !votes[currentPlayerId] && alive[currentPlayerId] !== false && lastNotifiedPhase !== currentPhaseKey){
                showNotification('VotaciÃ³n', 'Es hora de votar', 'ðŸ—³ï¸');
                localStorage.setItem('lastNotifiedPhase', currentPhaseKey);
            }
            if(data.phase === "lobby" || data.phase === "ended"){
                localStorage.removeItem('lastNotifiedPhase');
            }
            
            // Resetear lastShownEjectedId cuando cambia la fase o se resetea la partida
            if(data.phase !== "voting" || !data.lastEjectedId){
                if(data.phase === "lobby" || data.phase === "clues" || data.phase === "ended"){
                    lastShownEjectedId = null;
                }
            }

            if(isHost){
                const hostPlays=(data.hostPlays!==false);
                const playingIds=hostPlays?ids:ids.filter(id=>id!==data.hostId);
                const playerCount=playingIds.length;
                
                // Mostrar/ocultar campos segÃºn el modo
                const wordConfigSection = document.getElementById('word-config-section');
                const participantHint = document.getElementById('participant-mode-hint');
                if(wordConfigSection && participantHint){
                    if(hostPlays){
                        // Participante: ocultar campos de palabra
                        wordConfigSection.style.display='none';
                        participantHint.style.display='block';
                    }else{
                        // Solo anfitriÃ³n: mostrar campos
                        wordConfigSection.style.display='block';
                        participantHint.style.display='none';
                        
                        // Si no hay palabra y es solo anfitriÃ³n, generar automÃ¡ticamente
                        if(!data.secretWord && !rolesAssigned){
                            const randomPair = RANDOM_WORDS[Math.floor(Math.random()*RANDOM_WORDS.length)];
                            db.ref("rooms/"+roomCode).update({
                                secretWord: randomPair.word,
                                hint: randomPair.hint,
                                isRandomWord: true
                            });
                        }
                    }
                }
                applyTimerSettingsFromData(data);
                
                if(data.secretWord && playerCount>=3 && playerCount<=15 && !rolesAssigned){
                    startGameBtn.disabled=false;
                    setHostStatus("Cuando quieras, pulsa 'Empezar partida'. ("+playerCount+" jugadores)");
                }else if(!data.secretWord && !hostPlays){
                    startGameBtn.disabled=true;
                    setHostStatus("Generando palabra automÃ¡ticamente...");
                }else if(!data.secretWord && hostPlays){
                    // Si es participante, generar palabra automÃ¡ticamente
                    const randomPair = RANDOM_WORDS[Math.floor(Math.random()*RANDOM_WORDS.length)];
                    db.ref("rooms/"+roomCode).update({
                        secretWord: randomPair.word,
                        hint: giveHintCheckbox.checked ? randomPair.hint : "",
                        isRandomWord: true
                    });
                    startGameBtn.disabled=true;
                    setHostStatus("Palabra generada. Espera a que haya mÃ¡s jugadores.");
                }else if(playerCount<3){
                    startGameBtn.disabled=true;
                    setHostStatus("Necesitas mÃ­nimo 3 jugadores (tienes "+playerCount+").");
                }else if(playerCount>15){
                    startGameBtn.disabled=true;
                    setHostStatus("MÃ¡ximo 15 jugadores (tienes "+playerCount+").");
                }else{
                    startGameBtn.disabled=true;
                    setHostStatus("La partida ya estÃ¡ en marcha.");
                }

                const aliveIds=ids.filter(id=>alive[id]!==false);
                const clues=data.clues||{};
                const allHaveClue=aliveIds.length>0 && aliveIds.every(id=>clues[id]);
                
                // Verificar victoria del impostor cuando quedan 2 personas
                if(rolesAssigned && data.winner==null && aliveIds.length<=2){
                    const impostorId=data.impostorId;
                    const impostorAlive=alive[impostorId]!==false;
                    if(impostorAlive && aliveIds.length===2){
                        // Solo quedan impostor + 1 persona, el impostor gana
                        db.ref("rooms/"+roomCode).update({
                            phase:"ended",
                            winner:"impostor"
                        }).then(()=>{
                            showToast('warning','Â¡El impostor gana!','Solo quedaba 1 persona restante');
                        });
                        return;
                    }
                }
                
                // VotaciÃ³n intermitente cuando todos tienen pistas
                if(rolesAssigned && data.phase==="clues" && data.winner==null && allHaveClue){
                    // Activar prompt si no estÃ¡ activo (o si viene de votaciÃ³n anterior)
                    if((!data.votePromptActive && !data.autoVoteScheduled) || data.autoVoteOnAllClues){
                        db.ref("rooms/"+roomCode).update({
                            votePromptActive:true,
                            votePromptStartTime:Date.now(),
                            votePromptResponses:{},
                            autoVoteScheduled:true,
                            autoVoteOnAllClues:false
                        });
                    }
                    
                    // Mostrar modal si estÃ¡ activo
                    if(data.votePromptActive){
                        showVotePromptModal(data, roomCode, aliveIds);
                        
                        // Verificar si todos respondieron o timeout (solo el host procesa)
                        if(isHost){
                            const responses=data.votePromptResponses||{};
                            const hostId=data.hostId;
                            const hostPlays=(data.hostPlays!==false);
                            // Excluir host espectador del conteo
                            const votingPlayers=aliveIds.filter(id=>!(id===hostId && !hostPlays));
                            const allResponded=votingPlayers.length>0 && votingPlayers.every(id=>responses[id]!==undefined);
                            const startTime=data.votePromptStartTime||Date.now();
                            const elapsed=(Date.now()-startTime)/1000;
                            
                            if(allResponded || elapsed>=5){
                                // Obtener respuestas actualizadas desde Firebase y procesar resultado
                                (async()=>{
                                    const roomRef = db.ref("rooms/"+roomCode);
                                    const currentSnap = await roomRef.get();
                                    if(!currentSnap.exists()) return;
                                    const currentData = currentSnap.val();
                                    const currentResponses = currentData.votePromptResponses || {};
                                    
                                    // Contar votos
                                    const yesCount = Object.values(currentResponses).filter(r => r === true).length;
                                    const noCount = Object.values(currentResponses).filter(r => r === false).length;
                                    
                                    let shouldVote = false;
                                    
                                    if(yesCount > noCount){
                                        // MÃ¡s votos para votar
                                        shouldVote = true;
                                    }else if(noCount > yesCount){
                                        // MÃ¡s votos para seguir con pistas
                                        shouldVote = false;
                                    }else{
                                        // Empate 50%/50% - elegir aleatoriamente
                                        shouldVote = Math.random() >= 0.5;
                                    }
                                    
                                    if(shouldVote){
                                        // Pasar a votaciÃ³n
                                        await roomRef.update({
                                            phase:"voting",
                                            voteResolved:false,
                                            votePromptActive:false,
                                            autoVoteScheduled:false
                                        });
                                    }else{
                                        // Seguir con pistas - limpiar pistas y continuar
                                        await roomRef.update({
                                            clues:{},
                                            votePromptActive:false,
                                            autoVoteScheduled:false,
                                            votePromptResponses:{},
                                            autoVoteOnAllClues:true
                                        });
                                    }
                                })();
                            }
                        }
                    }
                }else{
                    // Ocultar modal si no aplica
                    if(votePromptModal) votePromptModal.style.display="none";
                    if(votePromptInterval){
                        clearInterval(votePromptInterval);
                        votePromptInterval=null;
                    }
                }
                
                // Ocultar botÃ³n de votaciÃ³n manual (ahora es automÃ¡tico)
                startVoteBtn.style.display="none";

                if(data.phase==="voting" && data.winner==null && !data.voteResolved){
                    const votes=data.votes||{};
                    const hostId=data.hostId;
                    const hostPlays=(data.hostPlays!==false);
                    // Excluir host espectador del conteo de votos necesarios
                    const votingPlayers=aliveIds.filter(id=>!(id===hostId && !hostPlays));
                    // Solo contar votos de jugadores vivos
                    const votesCount=votingPlayers.filter(id=>votes[id] && alive[id]!==false).length;
                    if(votingPlayers.length>0 && votesCount>=votingPlayers.length){
                        resolveVoting(roomCode,data,ids,aliveIds);
                    }
                }
            }
        });
    }

    async function resolveVoting(roomCode,data,ids,aliveIds){
        const votes=data.votes||{};
        const alive=data.alive||{};
        const impostorId=data.impostorId;
        const hostId=data.hostId;
        const hostPlays=(data.hostPlays!==false);
        const timerEnabled=data.timerEnabled!==false;
        const clueSeconds=timerEnabled?clampTimerValue(data.clueTimerSeconds||60,60):null;
        const count={};
        // Inicializar contador solo para jugadores que pueden ser expulsados (excluir host espectador)
        aliveIds.forEach(id=>{
            if(id===hostId && !hostPlays) return; // Host espectador no puede ser expulsado
            count[id]=0;
        });
        Object.keys(votes).forEach(voter=>{
            // Solo contar votos de jugadores vivos
            if(alive[voter] === false) return;
            const t=votes[voter].targetId;
            // Ignorar votos hacia el host espectador
            if(t && count[t]!=null && !(t===hostId && !hostPlays)) count[t]++; 
        });
        let ejectedId=null,max=-1;
        Object.keys(count).forEach(id=>{
            if(count[id]>max){max=count[id];ejectedId=id;}
        });
        
        // Verificar empates (excluyendo host espectador)
        if(max>0){
            const tiedIds=Object.keys(count).filter(id=>count[id]===max && !(id===hostId && !hostPlays));
            if(tiedIds.length>1){
                // Hay empate, elegir aleatoriamente entre los empatados
                ejectedId=tiedIds[Math.floor(Math.random()*tiedIds.length)];
                showToast('info','Empate en votaciÃ³n','Se eligiÃ³ aleatoriamente entre los empatados');
            }
        }
        
        if(!ejectedId || max===0){
            await db.ref("rooms/"+roomCode).update({voteResolved:true});
            showToast('info','Sin expulsiÃ³n','No hubo suficientes votos para expulsar a alguien');
            return;
        }
        const newAlive={...alive,[ejectedId]:false};
        const remainingAliveIds=aliveIds.filter(id=>id!==ejectedId);
        const remainingAliveCount=remainingAliveIds.length;
        
        // Verificar victoria del impostor ANTES de actualizar
        const impostorAlive=newAlive[impostorId]!==false;
        if(impostorAlive && remainingAliveCount<=1){
            // El impostor gana porque solo queda 1 persona
            const updateObj={
                alive:newAlive,
                lastEjectedId:ejectedId,
                voteResolved:true,
                phase:"ended",
                winner:"impostor",
                phaseTimerEndsAt:null,
                phaseTimerSeconds:null
            };
            await db.ref("rooms/"+roomCode).update(updateObj);
            setTimeout(()=>{
                showToast('warning','Â¡El impostor gana!','Solo quedaba 1 persona restante');
            },500);
            return;
        }
        
        const updateObj={alive:newAlive,lastEjectedId:ejectedId,voteResolved:true};
        if(ejectedId===impostorId){
            updateObj.phase="ended";
            updateObj.winner="players";
            updateObj.phaseTimerEndsAt=null;
            updateObj.phaseTimerSeconds=null;
            // El mensaje se mostrarÃ¡ en el listener principal
        }else{
            // Verificar de nuevo despuÃ©s de la expulsiÃ³n si el impostor gana
            if(impostorAlive && remainingAliveCount<=1){
                updateObj.phase="ended";
                updateObj.winner="impostor";
                updateObj.phaseTimerEndsAt=null;
                updateObj.phaseTimerSeconds=null;
                setTimeout(()=>{
                    showToast('warning','Â¡El impostor gana!','Solo quedaba 1 persona restante');
                },500);
            }else{
                // Verificar si viene de votaciÃ³n para activar automÃ¡ticamente la siguiente
                const cameFromVoting=data.phase==="voting";
                updateObj.phase="clues";
                updateObj.round=(data.round||1)+1;
                updateObj.clues=null;
                updateObj.votes=null;
                updateObj.winner=null;
                updateObj.votePromptActive=false;
                updateObj.votePromptResponses={};
                updateObj.autoVoteScheduled=false;
                updateObj.phaseTimerSeconds=timerEnabled?clueSeconds:null;
                updateObj.phaseTimerEndsAt=timerEnabled?Date.now()+clueSeconds*1000:null;
                // Si viene de votaciÃ³n, marcar para activar votaciÃ³n automÃ¡tica cuando todos tengan pistas
                if(cameFromVoting){
                    updateObj.autoVoteOnAllClues=true;
                }
                setTimeout(()=>{
                    showToast('info','Nueva ronda','Ronda '+(updateObj.round)+' iniciada');
                },500);
            }
        }
        await db.ref("rooms/"+roomCode).update(updateObj);
    }

    // CONFIG HOST / RANDOM WORD
    randomWordBtn.addEventListener("click",()=>{
        const pair=RANDOM_WORDS[Math.floor(Math.random()*RANDOM_WORDS.length)];
        secretWordInput.value=pair.word;
        hintInput.value=pair.hint;
        updateHostConfig();
    });
    giveHintCheckbox.addEventListener("change",async()=>{
        if(!isHost || !currentRoomCode) return;
        const roomRef = db.ref("rooms/"+currentRoomCode);
        const snap = await roomRef.get();
        if(!snap.exists()) return;
        const data = snap.val();
        const hostPlays = (data.hostPlays !== false);
        
        if(hostPlays){
            // Si es participante, solo actualizar hintEnabled
            await roomRef.update({
                hintEnabled: giveHintCheckbox.checked,
                hint: giveHintCheckbox.checked ? (data.hint || "") : ""
            });
        }else{
            // Si es solo anfitriÃ³n, actualizar normalmente
            updateHostConfig();
        }
    });
    secretWordInput.addEventListener("input",updateHostConfig);
    hintInput.addEventListener("input",updateHostConfig);
    expectedPlayersInput.addEventListener("input",updateHostConfig);
    if(timerEnabledCheckbox){
        updateTimerInputsState();
        timerEnabledCheckbox.addEventListener("change",()=>{
            updateTimerInputsState();
            updateHostConfig();
        });
    }
    if(clueTimerInput){
        clueTimerInput.addEventListener("change",()=>{
            clueTimerInput.value = clampTimerValue(clueTimerInput.value,60);
            updateHostConfig();
        });
    }
    if(voteTimerInput){
        voteTimerInput.addEventListener("change",()=>{
            voteTimerInput.value = clampTimerValue(voteTimerInput.value,45);
            updateHostConfig();
        });
    }

    async function updateHostConfig(){
        if(!isHost || !currentRoomCode) return;
        const sw=secretWordInput.value.trim();
        const h=hintInput.value.trim();
        const exp=parseInt(expectedPlayersInput.value,10)||3;
        const timerOn = !timerEnabledCheckbox || timerEnabledCheckbox.checked;
        const clueSeconds = clampTimerValue(clueTimerInput ? clueTimerInput.value : 60, 60);
        const voteSeconds = clampTimerValue(voteTimerInput ? voteTimerInput.value : 45, 45);
        const updates = {
            secretWord:sw,
            hint:h,
            hintEnabled:giveHintCheckbox.checked,
            expectedPlayers:exp,
            timerEnabled:timerOn,
            clueTimerSeconds:clueSeconds,
            voteTimerSeconds:voteSeconds
        };
        if(!timerOn){
            updates.phaseTimerEndsAt = null;
            updates.phaseTimerSeconds = null;
        }
        await db.ref("rooms/"+currentRoomCode).update(updates);
    }

    // Modal de selecciÃ³n de modo
    modeCards.forEach(card => {
        card.addEventListener('click', () => {
            modeCards.forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedMode = card.dataset.mode;
            confirmModeBtn.disabled = false;
        });
    });

    confirmModeBtn.addEventListener('click', async () => {
        if (!selectedMode) return;
        modeSelectionModal.style.display = 'none';
        await createRoomWithMode(selectedMode);
    });

    // Cerrar modal al hacer clic fuera
    modeSelectionModal.addEventListener('click', (e) => {
        if (e.target === modeSelectionModal) {
            modeSelectionModal.style.display = 'none';
            selectedMode = null;
            modeCards.forEach(c => c.classList.remove('selected'));
            confirmModeBtn.disabled = true;
        }
    });

    // FunciÃ³n para crear sala con el modo seleccionado
    async function createRoomWithMode(mode) {
        const name = nicknameInput.value.trim();
        if (!name) {
            showToast('error', 'Error', 'Pon tu nombre');
            return;
        }
        const roomCode = generateRoomCode();
        const roomsRef = db.ref("rooms/" + roomCode);
        const playerId = "p_" + Date.now() + "_" + Math.random().toString(16).slice(2);
        const hostPlays = (mode === 'participant');

        createRoomBtn.disabled = true;
        createRoomBtn.innerHTML = '<span class="spinner"></span> Creando...';

        try {
            // Si es participante, generar palabra automÃ¡ticamente
            // Si es solo anfitriÃ³n, se generarÃ¡ cuando se suscriba a la sala
            let initialWord = "";
            let initialHint = "";
            let isRandom = false;
            
            if(hostPlays){
                // Participante: generar palabra automÃ¡ticamente
                const randomPair = RANDOM_WORDS[Math.floor(Math.random()*RANDOM_WORDS.length)];
                initialWord = randomPair.word;
                initialHint = randomPair.hint;
                isRandom = true;
            }
            
            botsEnabled = enableBotsCheckbox.checked;
            const botCount = botsEnabled ? parseInt(botCountInput?.value || 2) : 0;
            await roomsRef.set({
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                hostId: playerId,
                hostPlays: hostPlays,
                phase: "lobby",
                secretWord: initialWord,
                hint: initialHint,
                hintEnabled: true,
                expectedPlayers: 4,
                rolesAssigned: false,
                round: 1,
                isRandomWord: isRandom,
                timerEnabled: true,
                clueTimerSeconds: 60,
                voteTimerSeconds: 45,
                phaseTimerEndsAt: null,
                phaseTimerSeconds: null,
                botsEnabled: botsEnabled,
                bots: {},
                players: { [playerId]: { name: name, joinedAt: firebase.database.ServerValue.TIMESTAMP } }
            });
            
            // Si bots estÃ¡n activados, aÃ±adir bots automÃ¡ticamente
            if(botsEnabled && botCount > 0){
                const countToAdd = Math.min(botCount, 10); // MÃ¡ximo 10
                addBotsToRoom(roomCode, countToAdd);
            }

            currentRoomCode = roomCode;
            currentPlayerId = playerId;
            isHost = true;

            roomCodeDisplay.textContent = roomCode;
            roomInfo.style.display = "block";
            hostSettings.style.display = "block";
            roomStatusSmall.textContent = "Sala creada. Comparte el cÃ³digo.";
            // Ocultar configuraciÃ³n de bots despuÃ©s de crear la sala
            if(botConfigSection) botConfigSection.style.display = "none";
            showToast('success', 'Sala creada', 'CÃ³digo: ' + roomCode);
            subscribeRoom(roomCode);
        } catch (e) {
            showToast('error', 'Error', 'No se pudo crear la sala');
        } finally {
            createRoomBtn.disabled = false;
            createRoomBtn.textContent = "Crear sala";
        }
    }

    // CREAR SALA
    createRoomBtn.addEventListener("click", () => {
        const name = nicknameInput.value.trim();
        if (!name) {
            showToast('error', 'Error', 'Pon tu nombre');
            return;
        }
        // Mostrar modal de selecciÃ³n de modo
        selectedMode = null;
        modeCards.forEach(c => c.classList.remove('selected'));
        confirmModeBtn.disabled = true;
        modeSelectionModal.style.display = 'flex';
    });

    // UNIRSE
    joinRoomBtn.addEventListener("click",async()=>{
        const name=nicknameInput.value.trim();
        if(!name){showToast('error','Error','Pon tu nombre');return;}
        const code=roomCodeJoinInput.value.trim().toUpperCase();
        if(!code){showToast('error','Error','Pon el cÃ³digo de sala');return;}

        joinRoomBtn.disabled=true;
        joinRoomBtn.innerHTML='<span class="spinner"></span> Uniendo...';

        try{
            const roomRef=db.ref("rooms/"+code);
            const snap=await roomRef.get();
            if(!snap.exists()){showToast('error','Error','La sala no existe');return;}
            const data=snap.val();
            if(data.rolesAssigned){showToast('error','Error','La partida ya estÃ¡ empezada');return;}
            
            const players=data.players||{};
            const hostPlays=(data.hostPlays!==false);
            const playingIds=hostPlays?Object.keys(players):Object.keys(players).filter(id=>id!==data.hostId);
            if(playingIds.length>=15){
                showToast('error','Sala llena','MÃ¡ximo 15 jugadores');
                return;
            }

            const playerId="p_"+Date.now()+"_"+Math.random().toString(16).slice(2);
            await roomRef.child("players/"+playerId).set({
                name:name,
                joinedAt:firebase.database.ServerValue.TIMESTAMP
            });

            currentRoomCode=code;
            currentPlayerId=playerId;
            isHost=false;

            roomCodeDisplay.textContent=code;
            roomInfo.style.display="block";
            hostSettings.style.display="none";
            roomStatusSmall.textContent="Te has unido a la sala.";
            showToast('success','Unido a la sala','Bienvenido a la partida');
            subscribeRoom(code);
        }catch(e){
            showToast('error','Error','No se pudo unir a la sala');
        }finally{
            joinRoomBtn.disabled=false;
            joinRoomBtn.textContent="Unirse";
        }
    });

    // COPIAR CÃ“DIGO DE SALA
    copyCodeBtn.addEventListener("click",async()=>{
        if(!currentRoomCode) return;
        try{
            await navigator.clipboard.writeText(currentRoomCode);
            const originalText = copyCodeBtn.textContent;
            copyCodeBtn.textContent = "âœ… Copiado!";
            copyCodeBtn.style.background = "var(--accent-soft)";
            copyCodeBtn.style.borderColor = "var(--accent)";
            showToast('success','CÃ³digo copiado','El cÃ³digo de sala se ha copiado al portapapeles');
            setTimeout(()=>{
                copyCodeBtn.textContent = originalText;
                copyCodeBtn.style.background = "";
                copyCodeBtn.style.borderColor = "";
            },2000);
        }catch(e){
            // Fallback para navegadores antiguos
            const textArea = document.createElement("textarea");
            textArea.value = currentRoomCode;
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.select();
            try{
                document.execCommand('copy');
                showToast('success','CÃ³digo copiado','El cÃ³digo de sala se ha copiado al portapapeles');
            }catch(err){
                showToast('error','Error','No se pudo copiar el cÃ³digo');
            }
            document.body.removeChild(textArea);
        }
    });

    // SALIR
    // FunciÃ³n para mostrar modal de resultado final
    async function showGameResultModal(winner){
        if(!gameResultModal || !currentRoomCode) return;
        
        const roomRef = db.ref("rooms/"+currentRoomCode);
        const snap = await roomRef.get();
        if(!snap.exists()) return;
        const data = snap.val();
        
        const players = data.players || {};
        const impostorId = data.impostorId;
        const impostorName = players[impostorId]?.name || "Desconocido";
        const secretWord = data.secretWord || "N/A";
        const clues = data.clues || {};
        const alive = data.alive || {};
        const ids = Object.keys(players).sort((a,b)=>players[a].joinedAt-players[b].joinedAt);
        
        // Construir contenido detallado
        let content = "";
        
        if(winner==="impostor"){
            gameResultIcon.textContent="ðŸ˜ˆ";
            gameResultTitle.textContent="Â¡El impostor ha ganado!";
            gameResultTitle.style.color="var(--danger)";
            content += `<div style="margin:12px 0;padding:12px;background:var(--danger-soft);border-radius:10px;border:2px solid var(--danger);">
                <strong style="color:var(--danger);font-size:14px;">El impostor era: ${escapeHtml(impostorName)}</strong>
            </div>`;
        }else if(winner==="players"){
            gameResultIcon.textContent="ðŸŽ‰";
            gameResultTitle.textContent="Â¡Los jugadores han ganado!";
            gameResultTitle.style.color="var(--accent)";
            content += `<div style="margin:12px 0;padding:12px;background:var(--accent-soft);border-radius:10px;border:2px solid var(--accent);">
                <strong style="color:var(--accent);font-size:14px;">El impostor era: ${escapeHtml(impostorName)}</strong>
            </div>`;
        }else{
            gameResultIcon.textContent="ðŸ";
            gameResultTitle.textContent="Partida terminada";
            gameResultTitle.style.color="var(--text-main)";
        }
        
        // Palabra secreta
        content += `<div style="margin:10px 0;padding:12px;background:var(--card-bg);border-radius:10px;border:2px solid var(--border);">
            <div style="font-size:12px;color:var(--text-muted);margin-bottom:6px;">Palabra secreta:</div>
            <div style="font-size:20px;font-weight:700;color:var(--accent);">${escapeHtml(secretWord)}</div>
        </div>`;
        
        // Pistas ordenadas
        const clueEntries = Object.entries(clues).sort((a,b)=>a[1].timestamp - b[1].timestamp);
        if(clueEntries.length > 0){
            content += `<div style="margin:10px 0;padding:12px;background:var(--card-bg);border-radius:10px;border:2px solid var(--border);max-height:150px;overflow-y:auto;">
                <div style="font-size:12px;font-weight:600;margin-bottom:8px;color:var(--text-main);">Todas las pistas:</div>
                ${clueEntries.map(([id, clue])=>`
                    <div style="padding:6px;margin-bottom:4px;background:var(--accent-soft);border-radius:6px;font-size:12px;">
                        <strong>${escapeHtml(clue.name || players[id]?.name || "Jugador")}:</strong> ${escapeHtml(clue.text || "")}
                    </div>
                `).join("")}
            </div>`;
        }
        
        // Expulsiones
        const ejected = ids.filter(id=>alive[id]===false);
        if(ejected.length > 0){
            content += `<div style="margin:10px 0;padding:12px;background:var(--card-bg);border-radius:10px;border:2px solid var(--border);">
                <div style="font-size:12px;font-weight:600;margin-bottom:8px;color:var(--text-main);">Jugadores expulsados:</div>
                ${ejected.map(id=>`<div style="padding:5px;margin-bottom:3px;background:var(--danger-soft);border-radius:6px;font-size:12px;color:var(--danger);">
                    ${escapeHtml(players[id]?.name || "Jugador")} ${id===impostorId ? "(Era el impostor)" : ""}
                </div>`).join("")}
            </div>`;
        }
        
        // EstadÃ­sticas del jugador
        const stats = getStats();
        const wasImpostor = currentPlayerId === impostorId;
        const won = (winner === "players" && !wasImpostor) || (winner === "impostor" && wasImpostor);
        
        // Actualizar estadÃ­sticas
        updateStats(wasImpostor, won);
        
        // AÃ±adir panel de estadÃ­sticas
        content += `<div style="margin:16px 0;padding:16px;background:var(--card-bg);border-radius:12px;border:2px solid var(--border);">
            <div style="font-size:14px;font-weight:600;margin-bottom:12px;color:var(--text-main);">ðŸ“Š Tus estadÃ­sticas:</div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;font-size:12px;">
                <div style="padding:8px;background:var(--accent-soft);border-radius:8px;">
                    <div style="color:var(--text-muted);">Partidas</div>
                    <div style="font-size:16px;font-weight:700;color:var(--accent);">${stats.games}</div>
                </div>
                <div style="padding:8px;background:var(--accent-soft);border-radius:8px;">
                    <div style="color:var(--text-muted);">Victorias</div>
                    <div style="font-size:16px;font-weight:700;color:var(--accent);">${stats.wins}</div>
                </div>
                <div style="padding:8px;background:var(--danger-soft);border-radius:8px;">
                    <div style="color:var(--text-muted);">Derrotas</div>
                    <div style="font-size:16px;font-weight:700;color:var(--danger);">${stats.losses}</div>
                </div>
                <div style="padding:8px;background:var(--info-soft);border-radius:8px;">
                    <div style="color:var(--text-muted);">Como impostor</div>
                    <div style="font-size:16px;font-weight:700;color:#3b82f6;">${stats.asImpostor}</div>
                </div>
            </div>
            ${stats.games > 0 ? `<div style="margin-top:12px;padding:8px;background:var(--accent-soft);border-radius:8px;text-align:center;font-size:13px;">
                <strong>Ratio de victorias:</strong> ${Math.round((stats.wins / stats.games) * 100)}%
            </div>` : ''}
        </div>`;
        
        gameResultSubtitle.innerHTML = content;
        
        // Mostrar botones solo para el host
        if(isHost){
            if(newGameBtn) newGameBtn.style.display = "inline-block";
            if(exitGameBtn) exitGameBtn.style.display = "inline-block";
        }else{
            if(newGameBtn) newGameBtn.style.display = "none";
            if(exitGameBtn) exitGameBtn.style.display = "none";
        }
        
        gameResultModal.style.display="flex";
        
        // Efectos visuales
        if(won && wasImpostor){
            createVictoryParticles();
            playSound('victory');
        }else if(won){
            createVictoryParticles();
            playSound('victory');
        }
    }
    
    // FunciÃ³n para resetear la partida (nueva partida)
    async function resetGame(){
        if(!currentRoomCode) return;
        // Solo el host puede resetear
        if(!isHost){
            showToast('error', 'Error', 'Solo el anfitriÃ³n puede resetear la partida');
            return;
        }
        try{
            const roomRef = db.ref("rooms/"+currentRoomCode);
            await roomRef.update({
                phase:"lobby",
                rolesAssigned:false,
                round:1,
                alive:null,
                clues:null,
                votes:null,
                voteResolved:false,
                winner:null,
                lastEjectedId:null,
                impostorId:null,
                votePromptActive:false,
                votePromptResponses:{},
                autoVoteScheduled:false,
                autoVoteOnAllClues:false
            });
            if(gameResultModal) gameResultModal.style.display="none";
            lastShownWinner = null;
            lastShownEjectedId = null; // Resetear tambiÃ©n el ID de expulsiÃ³n mostrado
            showToast('success', 'Partida reseteada', 'La partida ha sido reseteada. Puedes empezar una nueva.');
        }catch(e){
            showToast('error', 'Error', 'No se pudo resetear la partida');
        }
    }
    
    // FunciÃ³n para salir completamente (volver al inicio)
    async function exitToMainMenu(){
        try{
            // Salir de la sala si estamos en una
            if(currentRoomCode && currentPlayerId){
                const roomRef = db.ref("rooms/"+currentRoomCode);
                const snap = await roomRef.get();
                if(snap.exists()){
                    const data = snap.val();
                    const players = data.players || {};
                    const bots = data.bots || {};
                    
                    // Eliminar jugador de la sala
                    const updates = {};
                    if(players[currentPlayerId]) updates["players/"+currentPlayerId] = null;
                    if(bots[currentPlayerId]) updates["bots/"+currentPlayerId] = null;
                    if(data.alive && data.alive[currentPlayerId] !== undefined) updates["alive/"+currentPlayerId] = null;
                    if(data.clues && data.clues[currentPlayerId]) updates["clues/"+currentPlayerId] = null;
                    if(data.votes && data.votes[currentPlayerId]) updates["votes/"+currentPlayerId] = null;
                    
                    await roomRef.update(updates);
                }
            }
            
            // Cerrar listener
            if(roomListener){
                roomListener.off();
                roomListener = null;
            }
            
            // Resetear variables
            currentRoomCode = null;
            currentPlayerId = null;
            isHost = false;
            selectedVoteTarget = null;
            currentSecretWord = null;
            lastShownWinner = null;
            
            // Ocultar modales
            if(gameResultModal) gameResultModal.style.display="none";
            if(votePromptModal) votePromptModal.style.display="none";
            if(votePromptInterval){
                clearInterval(votePromptInterval);
                votePromptInterval = null;
            }
            
            // Ocultar secciones de sala
            if(roomInfo) roomInfo.style.display="none";
            if(hostSettings) hostSettings.style.display="none";
            if(gamePhasePanel) gamePhasePanel.style.display="none";
            
            // Mostrar configuraciÃ³n de bots al volver al menÃº
            if(botConfigSection) botConfigSection.style.display="block";
            
            // Ocultar secciÃ³n de rol
            const roleHeader = document.getElementById('role-header');
            const roleSection = document.getElementById('role-section');
            if(roleHeader) roleHeader.style.display="none";
            if(roleSection) roleSection.style.display="none";
            if(roleCard) roleCard.style.display="none";
            
            // Resetear inputs
            if(nicknameInput) nicknameInput.value="";
            if(roomCodeJoinInput) roomCodeJoinInput.value="";
            if(secretWordInput) secretWordInput.value="";
            if(hintInput) hintInput.value="";
            
            // Resetear estado del checkbox de bots
            if(enableBotsCheckbox) enableBotsCheckbox.checked=false;
            if(botCountInputContainer) botCountInputContainer.style.display="none";
            
            // Resetear texto de estado
            if(roomStatusSmall) roomStatusSmall.textContent="Crea o Ãºnete a una sala para empezar.";
            
            showToast('info', 'Has salido', 'Has vuelto al menÃº principal');
        }catch(e){
            showToast('error', 'Error', 'No se pudo salir correctamente');
        }
    }
    
    // Event listeners para botones del modal de resultado
    if(newGameBtn){
        newGameBtn.addEventListener("click",async()=>{
            await resetGame();
        });
    }
    
    if(exitGameBtn){
        exitGameBtn.addEventListener("click",async()=>{
            await exitToMainMenu();
        });
    }
    
    leaveRoomBtn.addEventListener("click",async()=>{
        if(!currentRoomCode || !currentPlayerId) return;
        const ref=db.ref("rooms/"+currentRoomCode);
        const snap=await ref.get();
        if(snap.exists()){
            const data=snap.val();
            if(data.hostId===currentPlayerId) await ref.remove();
            else await ref.child("players/"+currentPlayerId).remove();
        }
        if(roomListener){roomListener.off();roomListener=null;}
        currentRoomCode=null;
        currentPlayerId=null;
        isHost=false;
        
        // Ocultar secciones de sala y partida
        if(roomInfo) roomInfo.style.display="none";
        if(hostSettings) hostSettings.style.display="none";
        if(gamePhasePanel) gamePhasePanel.style.display="none";
        if(roleCard) roleCard.style.display="none";
        
        // Ocultar secciones de rol
        const roleHeader = document.getElementById('role-header');
        const roleSection = document.getElementById('role-section');
        if(roleHeader) roleHeader.style.display="none";
        if(roleSection) roleSection.style.display="none";
        
        // Mostrar panel izquierdo de nuevo
        const mainSettingsCard = document.getElementById('main-settings-card');
        if(mainSettingsCard) mainSettingsCard.style.display="block";
        
        // Mostrar configuraciÃ³n de bots al salir
        if(botConfigSection) botConfigSection.style.display="block";
        
        // Resetear texto de estado
        if(roomStatusSmall) roomStatusSmall.textContent="Crea o Ãºnete a una sala para empezar.";
        
        // Limpiar lista de jugadores
        if(playersListDiv) playersListDiv.innerHTML="";
        
        // Ocultar modal de resultado si estÃ¡ abierto
        if(gameResultModal) gameResultModal.style.display="none";
        if(votePromptModal) votePromptModal.style.display="none";
        
        // Limpiar intervalos
        if(votePromptInterval){
            clearInterval(votePromptInterval);
            votePromptInterval=null;
        }
        
        // Resetear variables de estado
        lastShownEjectedId = null;
        lastShownWinner = null;
        
        showToast('info', 'Has salido', 'Has vuelto al menÃº principal');
    });

    // EMPEZAR PARTIDA
    startGameBtn.addEventListener("click",async()=>{
        if(!isHost || !currentRoomCode) return;
        const roomRef=db.ref("rooms/"+currentRoomCode);
        const snap=await roomRef.get();
        if(!snap.exists()) return;
        const data=snap.val();
        const players=data.players||{};
        const ids=Object.keys(players).sort((a,b)=>players[a].joinedAt-players[b].joinedAt);
        const hostPlays=data.hostPlays!==false;
        const playingIds=hostPlays?ids:ids.filter(id=>id!==data.hostId);
        
        if(!data.secretWord){
            showToast('error','Error','Necesitas poner una palabra secreta');
            return;
        }
        if(playingIds.length<3){
            showToast('error','Error','Necesitas mÃ­nimo 3 jugadores (tienes '+playingIds.length+')');
            return;
        }
        if(playingIds.length>15){
            showToast('error','Error','MÃ¡ximo 15 jugadores (tienes '+playingIds.length+')');
            return;
        }
        
        startGameBtn.disabled=true;
        startGameBtn.innerHTML='<span class="spinner"></span> Iniciando...';
        
        try{
            const alive={};
            const hostId=data.hostId;
            ids.forEach(id=>{
                alive[id]=!(id===hostId && !hostPlays);
            });
            const candidates=ids.filter(id=>alive[id]);
            const impostorId=candidates[Math.floor(Math.random()*candidates.length)];
            const timerEnabled = data.timerEnabled !== false;
            const clueSeconds = timerEnabled ? clampTimerValue(data.clueTimerSeconds || 60, 60) : null;

            await roomRef.update({
                rolesAssigned:true,
                impostorId:impostorId,
                phase:"clues",
                round:1,
                alive:alive,
                clues:null,
                votes:null,
                voteResolved:false,
                winner:null,
                lastEjectedId:null,
                phaseTimerSeconds: timerEnabled ? clueSeconds : null,
                phaseTimerEndsAt: timerEnabled ? Date.now()+clueSeconds*1000 : null
            });
            showToast('success','Partida iniciada','Â¡Que comience el juego!');
        }catch(e){
            showToast('error','Error','No se pudo iniciar la partida');
        }finally{
            startGameBtn.disabled=false;
            startGameBtn.textContent="Empezar partida";
        }
    });

    // PASAR A VOTACIÃ“N
    startVoteBtn.addEventListener("click",async()=>{
        if(!isHost || !currentRoomCode) return;
        const roomRef=db.ref("rooms/"+currentRoomCode);
        const snap=await roomRef.get();
        if(!snap.exists()) return;
        const data=snap.val();
        const timerEnabled=data.timerEnabled!==false;
        const seconds=timerEnabled?clampTimerValue(data.voteTimerSeconds||45,45):null;
        await roomRef.update({
            phase:"voting",
            voteResolved:false,
            votes:null,
            phaseTimerSeconds: timerEnabled ? seconds : null,
            phaseTimerEndsAt: timerEnabled ? Date.now()+seconds*1000 : null
        });
    });
    
    // Mostrar/ocultar input de cantidad de bots (solo durante creaciÃ³n de sala)
    const botConfigSection = document.getElementById('bot-config-section');
    if(enableBotsCheckbox && botCountInputContainer){
        enableBotsCheckbox.addEventListener("change",()=>{
            if(enableBotsCheckbox.checked){
                botCountInputContainer.style.display = "block";
            }else{
                botCountInputContainer.style.display = "none";
            }
        });
    }
    
    // FunciÃ³n para expulsar jugador de la sala
    async function kickPlayerFromRoom(roomCode, playerId, data){
        if(!isHost || !roomCode || !playerId) return;
        try{
            const roomRef = db.ref("rooms/"+roomCode);
            const snap = await roomRef.get();
            if(!snap.exists()) return;
            const currentData = snap.val();
            const phase = currentData.phase || "lobby";
            const rolesAssigned = !!currentData.rolesAssigned;
            
            // En lobby: expulsiÃ³n inmediata
            if(phase === "lobby" && !rolesAssigned){
                const players = currentData.players || {};
                const bots = currentData.bots || {};
                const alive = currentData.alive || {};
                const clues = currentData.clues || {};
                const votes = currentData.votes || {};
                
                const updates = {};
                if(players[playerId]) updates["players/"+playerId] = null;
                if(bots[playerId]) updates["bots/"+playerId] = null;
                if(alive[playerId] !== undefined) updates["alive/"+playerId] = null;
                if(clues[playerId]) updates["clues/"+playerId] = null;
                if(votes[playerId]) updates["votes/"+playerId] = null;
                
                await roomRef.update(updates);
                showToast('success', 'Jugador expulsado', 'El jugador ha sido expulsado de la sala');
                return;
            }
            
            // Durante partida: marcar como expulsado y verificar victoria
            if(rolesAssigned && phase !== "ended"){
                const alive = currentData.alive || {};
                const impostorId = currentData.impostorId;
                const updates = {};
                updates["alive/"+playerId] = false;
                updates["lastEjectedId"] = playerId;
                
                // Si se expulsa al impostor, ganan los no impostores
                if(playerId === impostorId){
                    updates["phase"] = "ended";
                    updates["winner"] = "players";
                    await roomRef.update(updates);
                    showToast('success', 'Â¡Victoria!', 'El impostor ha sido expulsado. Â¡Los jugadores normales ganan!');
                }else{
                    // Si se expulsa a un jugador normal, la partida continÃºa
                    await roomRef.update(updates);
                    showToast('success', 'Jugador expulsado', 'El jugador ha sido expulsado. La partida continÃºa.');
                }
            }
        }catch(e){
            showToast('error', 'Error', 'No se pudo expulsar al jugador');
        }
    }

    // FunciÃ³n para aÃ±adir bots a la sala
    async function addBotsToRoom(roomCode, count){
        const botNames = ["Bot Alex", "Bot Sara", "Bot Max", "Bot Luna", "Bot Tom", "Bot Ana", "Bot Leo", "Bot Mia", "Bot Zoe", "Bot Kai", "Bot Rio", "Bot Eva"];
        const roomRef = db.ref("rooms/"+roomCode);
        const snap = await roomRef.get();
        if(!snap.exists()) return;
        const data = snap.val();
        const bots = data.bots || {};
        const players = data.players || {};
        const alive = data.alive || {};
        const existingBotCount = Object.keys(bots).length;
        
        for(let i=0; i<count; i++){
            const botId = "bot_" + Date.now() + "_" + i + "_" + Math.random().toString(16).slice(2);
            const botName = botNames[(existingBotCount + i) % botNames.length];
            bots[botId] = {
                name: botName,
                joinedAt: Date.now() + i,
                isBot: true
            };
            players[botId] = {
                name: botName,
                joinedAt: Date.now() + i
            };
            // Los bots empiezan vivos
            alive[botId] = true;
        }
        
        await roomRef.update({bots: bots, players: players, alive: alive});
    }
    
    // FunciÃ³n para que los bots jueguen automÃ¡ticamente
    async function processBotActions(roomCode, data){
        if(!data.botsEnabled) return;
        const bots = data.bots || {};
        const players = data.players || {};
        const alive = data.alive || {};
        const clues = data.clues || {};
        const votes = data.votes || {};
        const aliveIds = Object.keys(players).filter(id=>alive[id]!==false && bots[id]);
        const phase = data.phase || "lobby";
        
        // Bots votan en el modal de votaciÃ³n intermitente
        if(data.votePromptActive && data.rolesAssigned){
            const responses = data.votePromptResponses || {};
            aliveIds.forEach(botId => {
                if(responses[botId] === undefined && alive[botId] !== false){
                    setTimeout(async()=>{
                        // Los bots votan aleatoriamente (70% sÃ­, 30% no)
                        const voteYes = Math.random() > 0.3;
                        const roomRef = db.ref("rooms/"+roomCode);
                        const snap = await roomRef.get();
                        if(!snap.exists()) return;
                        const currentData = snap.val();
                        const currentResponses = currentData.votePromptResponses || {};
                        currentResponses[botId] = voteYes;
                        await roomRef.update({votePromptResponses: currentResponses});
                    }, 1000 + Math.random() * 2000); // Delay aleatorio entre 1-3 segundos
                }
            });
        }
        
        if(phase === "clues" && data.rolesAssigned){
            // Bots dan pistas inteligentes
            const usedClues = new Set(Object.values(clues).map(c => c.text?.toLowerCase()));
            aliveIds.forEach(botId => {
                if(!clues[botId] && alive[botId] !== false){
                    setTimeout(async()=>{
                        const isImpostor = botId === data.impostorId;
                        let clueText = "";
                        if(isImpostor){
                            // Bot impostor: pistas NO relacionadas pero creÃ­bles
                            const impostorClues = [
                                "Algo interesante", "Una cosa comÃºn", "Algo que todos conocemos", 
                                "Un objeto familiar", "Algo del dÃ­a a dÃ­a", "Algo que se ve a menudo",
                                "Un elemento cotidiano", "Algo que existe", "Un objeto real",
                                "Algo que podemos tocar", "Un elemento bÃ¡sico", "Algo simple",
                                "Un objeto normal", "Algo corriente", "Un elemento comÃºn",
                                "Algo conocido", "Un objeto tÃ­pico", "Algo habitual"
                            ];
                            // Evitar repetir pistas
                            const available = impostorClues.filter(c => !usedClues.has(c.toLowerCase()));
                            clueText = available.length > 0 ? 
                                available[Math.floor(Math.random()*available.length)] :
                                impostorClues[Math.floor(Math.random()*impostorClues.length)];
                        }else{
                            // Bot normal: pistas relacionadas con la palabra (semÃ¡nticamente)
                            const word = (data.secretWord || "").toLowerCase();
                            const wordLength = word.length;
                            
                            // Pistas relacionadas segÃºn caracterÃ­sticas
                            const relatedClues = [];
                            if(wordLength <= 4){
                                relatedClues.push("Corto", "PequeÃ±o", "Breve", "Compacto", "Reducido");
                            }else if(wordLength <= 7){
                                relatedClues.push("Mediano", "Normal", "Regular", "EstÃ¡ndar", "Moderado");
                            }else{
                                relatedClues.push("Largo", "Extenso", "Amplio", "Grande", "Extendido");
                            }
                            
                            // Pistas semÃ¡nticas relacionadas
                            const semanticClues = [
                                "Algo Ãºtil", "Un lugar comÃºn", "Algo que se usa", 
                                "Un objeto conocido", "Algo familiar", "Un elemento bÃ¡sico",
                                "Algo prÃ¡ctico", "Un objeto real", "Algo tangible",
                                "Un elemento visible", "Algo concreto", "Un objeto fÃ­sico",
                                "Algo material", "Un elemento sÃ³lido", "Algo palpable",
                                "Algo comÃºn", "Un objeto tÃ­pico", "Algo habitual"
                            ];
                            
                            const allClues = [...relatedClues, ...semanticClues];
                            const available = allClues.filter(c => !usedClues.has(c.toLowerCase()));
                            clueText = available.length > 0 ? 
                                available[Math.floor(Math.random()*available.length)] :
                                allClues[Math.floor(Math.random()*allClues.length)];
                        }
                        usedClues.add(clueText.toLowerCase());
                        await db.ref("rooms/"+roomCode+"/clues/"+botId).set({
                            text: clueText,
                            playerId: botId,
                            name: players[botId]?.name || "Bot",
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        });
                    }, 1500 + Math.random() * 2500); // Delay aleatorio entre 1.5-4 segundos
                }
            });
        }
        
        if(phase === "voting" && data.rolesAssigned){
            // Bots siempre votan (nunca se abstienen)
            const hostId = data.hostId;
            const hostPlays = (data.hostPlays !== false);
            const impostorId = data.impostorId;
            aliveIds.forEach(botId => {
                if(!votes[botId] && alive[botId] !== false){
                    setTimeout(async()=>{
                        const isImpostor = botId === impostorId;
                        const otherAlive = Object.keys(players).filter(id=>
                            alive[id]!==false && 
                            id!==botId && 
                            !(id===hostId && !hostPlays)
                        );
                        if(otherAlive.length > 0){
                            let target;
                            if(isImpostor){
                                // Bot impostor: desvÃ­a el voto hacia otro jugador (no hacia sÃ­ mismo)
                                // Intenta votar por alguien que no sea sospechoso
                                target = otherAlive[Math.floor(Math.random()*otherAlive.length)];
                            }else{
                                // Bot no impostor: vota al mÃ¡s sospechoso segÃºn pistas
                                // Analizar pistas para encontrar al mÃ¡s sospechoso
                                const clueTexts = Object.entries(clues).map(([id, clue]) => ({
                                    id, text: clue.text?.toLowerCase() || ""
                                }));
                                const secretWordLower = (data.secretWord || "").toLowerCase();
                                
                                // Calcular "sospechosidad" basada en quÃ© tan genÃ©ricas son las pistas
                                const suspicion = {};
                                otherAlive.forEach(id => {
                                    const clue = clueTexts.find(c => c.id === id);
                                    if(clue){
                                        const genericWords = ["algo", "cosa", "objeto", "elemento", "comÃºn", "normal", "tÃ­pico"];
                                        const isGeneric = genericWords.some(w => clue.text.includes(w));
                                        suspicion[id] = isGeneric ? 1 : 0;
                                    }else{
                                        suspicion[id] = 0;
                                    }
                                });
                                
                                // Votar por el mÃ¡s sospechoso, o aleatoriamente si no hay sospechosos claros
                                const suspicious = otherAlive.filter(id => suspicion[id] > 0);
                                target = suspicious.length > 0 ? 
                                    suspicious[Math.floor(Math.random()*suspicious.length)] :
                                    otherAlive[Math.floor(Math.random()*otherAlive.length)];
                            }
                            await db.ref("rooms/"+roomCode+"/votes/"+botId).set({
                                targetId: target,
                                timestamp: firebase.database.ServerValue.TIMESTAMP
                            });
                        }
                    }, 1500 + Math.random() * 2500); // Delay aleatorio entre 1.5-4 segundos
                }
            });
        }
    }

    // FunciÃ³n para mostrar modal de votaciÃ³n intermitente
    function showVotePromptModal(data, roomCode, aliveIds){
        if(!votePromptModal) return;
        
        const responses=data.votePromptResponses||{};
        const startTime=data.votePromptStartTime||Date.now();
        const currentTime=Date.now();
        const elapsed=(currentTime-startTime)/1000;
        let remaining=Math.max(0,5-elapsed);
        
        votePromptModal.style.display="flex";
        votePromptTimer.textContent=Math.ceil(remaining);
        
        // FunciÃ³n para actualizar porcentajes
        const updatePercentages = () => {
            const yesCount = Object.values(responses).filter(r => r === true).length;
            const noCount = Object.values(responses).filter(r => r === false).length;
            const total = yesCount + noCount;
            const yesPercent = total > 0 ? Math.round((yesCount / total) * 100) : 0;
            const noPercent = total > 0 ? Math.round((noCount / total) * 100) : 0;
            
            const yesPercentEl = document.getElementById('vote-yes-percent');
            const noPercentEl = document.getElementById('vote-no-percent');
            if(yesPercentEl) yesPercentEl.textContent = `SÃ­: ${yesPercent}% (${yesCount})`;
            if(noPercentEl) noPercentEl.textContent = `No: ${noPercent}% (${noCount})`;
        };
        
        updatePercentages();
        
        // Actualizar timer y porcentajes cada 100ms
        if(votePromptInterval) clearInterval(votePromptInterval);
        votePromptInterval=setInterval(async()=>{
            const now=Date.now();
            const elapsed=(now-startTime)/1000;
            remaining=Math.max(0,5-elapsed);
            votePromptTimer.textContent=Math.ceil(remaining);
            
            // Actualizar respuestas desde Firebase
            const roomRef = db.ref("rooms/"+roomCode);
            const snap = await roomRef.get();
            if(snap.exists()){
                const currentData = snap.val();
                const currentResponses = currentData.votePromptResponses || {};
                Object.assign(responses, currentResponses);
                updatePercentages();
            }
            
            if(remaining<=0){
                clearInterval(votePromptInterval);
                votePromptInterval=null;
                votePromptModal.style.display="none";
            }
        },100);
        
        // Deshabilitar botones si ya respondiÃ³
        if(responses[currentPlayerId]!==undefined){
            votePromptYes.disabled=true;
            votePromptNo.disabled=true;
            if(responses[currentPlayerId]){
                votePromptYes.style.opacity="0.6";
                votePromptYes.textContent="âœ“ Votaste: SÃ­";
            }else{
                votePromptNo.style.opacity="0.6";
                votePromptNo.textContent="âœ“ Votaste: No";
            }
        }else{
            votePromptYes.disabled=false;
            votePromptNo.disabled=false;
            votePromptYes.style.opacity="1";
            votePromptNo.style.opacity="1";
            votePromptYes.textContent="SÃ­, votar";
            votePromptNo.textContent="Seguir pistas";
        }
    }
    
    // Handlers para votaciÃ³n intermitente
    if(votePromptYes && votePromptNo){
        votePromptYes.addEventListener("click",async()=>{
            if(!currentRoomCode || !currentPlayerId) return;
            const roomRef=db.ref("rooms/"+currentRoomCode);
            const snap=await roomRef.get();
            if(!snap.exists()) return;
            const data=snap.val();
            const responses=data.votePromptResponses||{};
            responses[currentPlayerId]=true;
            await roomRef.update({votePromptResponses:responses});
            votePromptYes.disabled=true;
            votePromptYes.style.opacity="0.6";
            votePromptYes.textContent="âœ“ Votaste: SÃ­";
        });
        
        votePromptNo.addEventListener("click",async()=>{
            if(!currentRoomCode || !currentPlayerId) return;
            const roomRef=db.ref("rooms/"+currentRoomCode);
            const snap=await roomRef.get();
            if(!snap.exists()) return;
            const data=snap.val();
            const responses=data.votePromptResponses||{};
            responses[currentPlayerId]=false;
            await roomRef.update({votePromptResponses:responses});
            votePromptNo.disabled=true;
            votePromptNo.style.opacity="0.6";
            votePromptNo.textContent="âœ“ Votaste: No";
        });
    }

    // FunciÃ³n para verificar si la pista contiene la palabra secreta
    function checkClueForSecretWord(){
        if(!currentSecretWord) return;
        const text = clueInput.value.trim().toLowerCase();
        const secretWordLower = currentSecretWord.toLowerCase();
        
        // Verificar si el texto contiene la palabra secreta exacta (como palabra completa)
        const wordRegex = new RegExp(`\\b${secretWordLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
        const containsExactWord = wordRegex.test(text);
        
        if(containsExactWord){
            clueInput.classList.add("clue-contains-secret-word");
            clueHintText.textContent = "âš ï¸ No puedes escribir la palabra secreta en tu pista!";
            clueHintText.style.color = "#ef4444";
            sendClueBtn.disabled = true;
        }else{
            clueInput.classList.remove("clue-contains-secret-word");
            if(clueHintText.textContent.includes("âš ï¸")){
                clueHintText.textContent = "Solo una pista por ronda. Cuando todos escriban, el host pasarÃ¡ a votaciÃ³n.";
                clueHintText.style.color = "";
            }
            sendClueBtn.disabled = false;
        }
    }

    // ENVIAR PISTA
    sendClueBtn.addEventListener("click",async()=>{
        if(!currentRoomCode || !currentPlayerId) return;
        const text=clueInput.value.trim();
        if(!text){
            showToast('error','Error','La pista no puede estar vacÃ­a');
            return;
        }
        if(text.length<3){
            showToast('error','Error','La pista debe tener al menos 3 caracteres');
            return;
        }
        if(text.length>100){
            showToast('error','Error','La pista no puede tener mÃ¡s de 100 caracteres');
            return;
        }
        
        // Verificar que no contenga la palabra secreta
        if(currentSecretWord){
            const textLower = text.toLowerCase();
            const secretWordLower = currentSecretWord.toLowerCase();
            const wordRegex = new RegExp(`\\b${secretWordLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
            if(wordRegex.test(textLower)){
                showToast('error','Error','No puedes escribir la palabra secreta en tu pista');
                return;
            }
        }
        
        sendClueBtn.disabled=true;
        sendClueBtn.innerHTML='<span class="spinner"></span>';
        
        try{
            const ref=db.ref("rooms/"+currentRoomCode+"/clues/"+currentPlayerId);
            await ref.set({
                text:text,
                playerId:currentPlayerId,
                name:nicknameInput.value.trim()||"Jugador",
                timestamp:firebase.database.ServerValue.TIMESTAMP
            });
            clueInput.value="";
            playSound('clue');
            sendClueBtn.classList.add("animate-bounce");
            showToast('success','Pista enviada','Tu pista ha sido registrada');
            setTimeout(()=>{
                sendClueBtn.classList.remove("animate-bounce");
            },500);
        }catch(e){
            showToast('error','Error','No se pudo enviar la pista');
        }finally{
            sendClueBtn.disabled=false;
            sendClueBtn.textContent="Enviar";
        }
    });

    // ENVIAR VOTO
    sendVoteBtn.addEventListener("click",async()=>{
        if(!currentRoomCode || !currentPlayerId) return;
        if(!selectedVoteTarget){showToast('error','Error','Selecciona a alguien para votar');return;}
        
        // Verificar que el jugador estÃ© vivo antes de votar
        const roomRef = db.ref("rooms/"+currentRoomCode);
        const snap = await roomRef.get();
        if(!snap.exists()) return;
        const data = snap.val();
        const alive = data.alive || {};
        if(alive[currentPlayerId] === false){
            showToast('error','Error','No puedes votar, estÃ¡s expulsado');
            return;
        }
        
        sendVoteBtn.disabled=true;
        sendVoteBtn.innerHTML='<span class="spinner"></span> Votando...';
        
        try{
            const ref=db.ref("rooms/"+currentRoomCode+"/votes/"+currentPlayerId);
            await ref.set({
                targetId:selectedVoteTarget,
                timestamp:firebase.database.ServerValue.TIMESTAMP
            });
            playSound('vote');
            sendVoteBtn.classList.add("animate-pulse-glow");
            showToast('success','Voto registrado','Tu voto ha sido contabilizado');
            setTimeout(()=>{
                sendVoteBtn.classList.remove("animate-pulse-glow");
            },1500);
        }catch(e){
            showToast('error','Error','No se pudo registrar el voto');
        }finally{
            sendVoteBtn.disabled=false;
            sendVoteBtn.textContent="Confirmar voto";
        }
    });

    // CHAT GENERAL
    sendChatBtn.addEventListener("click",async()=>{
        if(!currentRoomCode || !currentPlayerId) return;
        const text=chatInput.value.trim();
        if(!text) return;
        const msgRef=db.ref("rooms/"+currentRoomCode+"/chat").push();
        await msgRef.set({
            playerId:currentPlayerId,
            name:nicknameInput.value.trim()||"Jugador",
            text:text,
            timestamp:firebase.database.ServerValue.TIMESTAMP
        });
        chatInput.value="";
    });

    function autoFillMissingClues(roomCode,data,missingIds){
        if(!missingIds.length) return Promise.resolve();
        const updates={};
        missingIds.forEach(id=>{
            updates[`clues/${id}`]={
                text:"(no enviÃ³ pista)",
                autoFilled:true,
                timestamp:firebase.database.ServerValue.TIMESTAMP
            };
        });
        return db.ref("rooms/"+roomCode).update(updates);
    }

    async function advanceToVoting(roomCode,data){
        if(!isHost || !roomCode || data.phase!=="clues" || data.winner!=null) return;
        if(window.__advancingToVoting) return;
        window.__advancingToVoting=true;
        try{
            const timerEnabled=data.timerEnabled!==false;
            const seconds = timerEnabled ? clampTimerValue(data.voteTimerSeconds || 45,45) : null;
            await db.ref("rooms/"+roomCode).update({
                phase:"voting",
                votePromptActive:false,
                votePromptResponses:null,
                votes:null,
                voteResolved:false,
                phaseTimerSeconds:timerEnabled?seconds:null,
                phaseTimerEndsAt: timerEnabled ? Date.now() + seconds*1000 : null
            });
        }finally{
            window.__advancingToVoting=false;
        }
    }

    // MÃšSICA
    // Configurar volumen inicial
    musicAudio.volume = 0.5;
    musicVolumeSlider.value = 50;
    
    // Control de volumen
    musicVolumeSlider.addEventListener("input",(e)=>{
        const volume = e.target.value / 100;
        musicAudio.volume = volume;
        localStorage.setItem('musicVolume', volume);
    });
    
    // Cargar volumen guardado
    const savedVolume = localStorage.getItem('musicVolume');
    if(savedVolume !== null){
        musicAudio.volume = parseFloat(savedVolume);
        musicVolumeSlider.value = parseFloat(savedVolume) * 100;
    }
    
    musicToggleBtn.addEventListener("click",()=>{
        if(!musicOn){
            musicAudio.play().catch(()=>{});
            musicOn=true;
            musicToggleBtn.textContent="â¸ MÃºsica";
            musicVolumeControl.style.display="flex";
        }else{
            musicAudio.pause();
            musicOn=false;
            musicToggleBtn.textContent="ðŸŽµ MÃºsica";
            musicVolumeControl.style.display="none";
        }
    });
    
    // Control de sonidos
    if(soundsToggleBtn){
        soundsToggleBtn.textContent = soundsEnabled ? "ðŸ”Š Sonidos" : "ðŸ”‡ Sonidos";
        soundsToggleBtn.addEventListener("click",()=>{
            soundsEnabled = !soundsEnabled;
            localStorage.setItem('soundsEnabled', soundsEnabled);
            soundsToggleBtn.textContent = soundsEnabled ? "ðŸ”Š Sonidos" : "ðŸ”‡ Sonidos";
            if(soundsEnabled) playSound('success');
            showToast('info', soundsEnabled ? 'Sonidos activados' : 'Sonidos desactivados', '');
        });
    }
</script>
</body>
</html>

